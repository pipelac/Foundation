# Changelog - OpenRouterMetrics

Все изменения класса `OpenRouterMetrics` документируются в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/).

## [1.0.0] - 2024-10-28

### Добавлено

#### Основной функционал
- ✅ Создан класс `OpenRouterMetrics` для работы с метриками OpenRouter API
- ✅ Полная интеграция с Http классом для выполнения запросов
- ✅ Поддержка логирования через Logger
- ✅ Строгая типизация всех параметров и возвращаемых значений
- ✅ Полная PHPDoc документация на русском языке

#### Методы для работы с балансом и лимитами
- `getKeyInfo()` - получение информации о API ключе
- `getBalance()` - проверка текущего баланса
- `getUsageStats()` - детальная статистика использования
- `getRateLimits()` - информация о лимитах запросов
- `hasEnoughBalance()` - проверка достаточности баланса

#### Методы для работы с моделями
- `getModels()` - получение списка всех доступных моделей
- `getModelInfo()` - детальная информация о конкретной модели
- `estimateCost()` - оценка стоимости запроса до его выполнения

#### Методы для работы с генерациями
- `getGenerationInfo()` - получение информации о выполненной генерации
- `getAccountStatus()` - полная информация о состоянии аккаунта

#### Обработка ошибок
- Использование существующей иерархии исключений OpenRouter:
  - `OpenRouterException` - базовое исключение
  - `OpenRouterValidationException` - ошибки валидации параметров
  - `OpenRouterApiException` - ошибки API (4xx, 5xx коды)
  - `OpenRouterNetworkException` - сетевые ошибки
- Детальное логирование всех ошибок при наличии Logger

#### Валидация
- Валидация API ключа при инициализации
- Валидация всех входных параметров методов
- Проверка пустых строк и отрицательных значений
- Проверка корректности структуры ответов API

#### Документация и примеры
- `docs/OPENROUTER_METRICS.md` - полная документация класса
- `OPENROUTER_METRICS_QUICKSTART.md` - краткое руководство для быстрого старта
- `examples/openrouter_metrics_example.php` - практический пример использования
- Обновлен `README.md` с разделом об OpenRouterMetrics
- Добавлен в структуру проекта и список компонентов

#### Конфигурация
- Использование той же конфигурации что и OpenRouter класс (`config/openrouter.json`)
- Поддержка параметров:
  - `api_key` (обязательно) - API ключ OpenRouter
  - `app_name` (опционально) - название приложения
  - `timeout` (опционально) - таймаут запросов
  - `retries` (опционально) - количество повторных попыток

#### Технические особенности
- Использование константы `BASE_URL` для API endpoint
- Константа `DEFAULT_TIMEOUT` для таймаута по умолчанию
- Приватные методы для валидации и обработки данных
- Метод `calculateCostFromUsage()` для вычисления стоимости из данных использования
- Метод `buildHeaders()` для формирования стандартных заголовков
- Метод `sendRequest()` для унифицированных HTTP запросов

### Особенности реализации

#### Архитектура
- Следует тем же паттернам что и другие компоненты проекта
- Constructor injection для Http и Logger
- Использование приватных методов для валидации и вспомогательных операций
- Строгая типизация с PHPDoc аннотациями

#### Работа с API
- Поддержка GET запросов к OpenRouter API
- Автоматическая обработка JSON ответов
- Обработка ошибок HTTP 4xx и 5xx
- Логирование всех ошибочных запросов

#### Возвращаемые данные
- Все методы возвращают структурированные массивы
- Аннотация структуры данных в PHPDoc
- Приведение типов для всех значений
- Обработка отсутствующих полей в ответах API

### API Endpoints

Класс использует следующие OpenRouter API endpoints:

1. `GET /auth/key` - информация о ключе API
   - Используется в: `getKeyInfo()`, `getBalance()`, `getUsageStats()`, `getRateLimits()`, `getAccountStatus()`

2. `GET /models` - список доступных моделей
   - Используется в: `getModels()`, `getModelInfo()`, `estimateCost()`

3. `GET /generation?id={id}` - информация о генерации
   - Используется в: `getGenerationInfo()`

### Практические сценарии использования

#### Мониторинг бюджета
```php
$stats = $metrics->getUsageStats();
if ($stats['usage_percent'] > 80) {
    // Отправить уведомление администратору
}
```

#### Выбор оптимальной модели
```php
$models = $metrics->getModels();
// Сравнение моделей по стоимости и выбор наиболее подходящей
```

#### Проверка перед запросом
```php
$estimate = $metrics->estimateCost($modelId, $promptTokens, $completionTokens);
if ($metrics->hasEnoughBalance($estimate['total_cost'])) {
    // Выполнить запрос к OpenRouter
}
```

#### Получение статистики по генерациям
```php
$generationInfo = $metrics->getGenerationInfo($generationId);
// Анализ использованных токенов и стоимости
```

### Тестирование

- Создан полный пример использования в `examples/openrouter_metrics_example.php`
- Демонстрация всех основных методов
- Обработка исключений
- Форматированный вывод результатов

### Интеграция

- Добавлен в autoload.php (поддержка автозагрузки)
- Обновлен README.md с примерами использования
- Создана подробная документация
- Добавлен в список компонентов проекта

### Ограничения и замечания

1. Требуется валидный API ключ OpenRouter
2. Информация о генерациях доступна ограниченное время
3. Rate limits определяются индивидуально для каждого ключа
4. Стоимость моделей может меняться - рекомендуется кэширование списка моделей
5. Для ключей без лимита метод `getBalance()` возвращает отрицательное значение

### Зависимости

- PHP 8.1+
- GuzzleHttp/Guzzle (через Http класс)
- App\Component\Http
- App\Component\Logger (опционально)
- Расширения: json, curl

### Совместимость

- Полностью совместим с существующей архитектурой проекта
- Использует те же конфигурационные файлы что и OpenRouter
- Может работать как с Logger так и без него
- Не конфликтует с существующим классом OpenRouter

## Будущие улучшения (Roadmap)

### Возможные дополнения в будущих версиях:

- [ ] Кэширование списка моделей с автоматическим обновлением
- [ ] Метод для получения истории генераций
- [ ] Поддержка webhook уведомлений о балансе
- [ ] Экспорт статистики в различные форматы (CSV, JSON)
- [ ] Графическое представление статистики использования
- [ ] Интеграция с системами мониторинга (Prometheus, Grafana)
- [ ] Автоматические алерты при достижении порогов
- [ ] Поддержка множественных API ключей
- [ ] Анализ эффективности использования разных моделей
- [ ] Рекомендации по оптимизации расходов

## Ссылки

- Документация OpenRouter API: https://openrouter.ai/docs
- Репозиторий проекта: (ссылка на GitHub)
- Раздел Issues для отчетов об ошибках: (ссылка)

---

**Примечание**: Этот класс был создан в соответствии со всеми стандартами проекта:
- Строгая типизация
- PHPDoc на русском языке
- Описательные имена методов
- Обработка исключений на каждом уровне
- Надежный и легко поддерживаемый код
