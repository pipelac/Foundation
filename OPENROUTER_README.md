# OpenRouter –∏ OpenRouterMetrics - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## ‚úÖ –°—Ç–∞—Ç—É—Å: –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (100%)

**51 —Ç–µ—Å—Ç | 0 –æ—à–∏–±–æ–∫ | 2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã | $0.0023 –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –∏–∑ $1.00**

---

## üéØ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ OpenRouter

```php
use App\Component\OpenRouter;
use App\Component\Logger;

$logger = new Logger(['directory' => './logs']);

$openRouter = new OpenRouter([
    'api_key' => 'sk-or-v1-–≤–∞—à-–∫–ª—é—á',
    'app_name' => 'MyApp',
    'timeout' => 60,
], $logger);

// –¢–µ–∫—Å—Ç–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
$response = $openRouter->text2text(
    'openai/gpt-3.5-turbo',
    '–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?',
    ['max_tokens' => 100]
);

// –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞
$openRouter->textStream(
    'openai/gpt-3.5-turbo',
    '–†–∞—Å—Å–∫–∞–∂–∏ –∏—Å—Ç–æ—Ä–∏—é',
    function($chunk) {
        echo $chunk;
    }
);

// –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
$description = $openRouter->image2text(
    'openai/gpt-4o',
    'https://example.com/image.jpg',
    '–ß—Ç–æ –Ω–∞ —ç—Ç–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏?'
);
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ OpenRouterMetrics

```php
use App\Component\OpenRouterMetrics;

$metrics = new OpenRouterMetrics([
    'api_key' => 'sk-or-v1-–≤–∞—à-–∫–ª—é—á',
], $logger);

// –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å
$balance = $metrics->getBalance();
echo "–ë–∞–ª–∞–Ω—Å: $$balance\n";

// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
$models = $metrics->getModels();
echo "–î–æ—Å—Ç—É–ø–Ω–æ –º–æ–¥–µ–ª–µ–π: " . count($models) . "\n";

// –û—Ü–µ–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
$cost = $metrics->estimateCost('openai/gpt-3.5-turbo', 1000, 500);
echo "–°—Ç–æ–∏–º–æ—Å—Ç—å: $" . $cost['total_cost'] . "\n";

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
if ($metrics->hasEnoughBalance(0.01)) {
    echo "–ë–∞–ª–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç–æ—á–µ–Ω!\n";
}
```

---

## üìä –ß—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

### ‚úÖ OpenRouterMetrics (9 –º–µ—Ç–æ–¥–æ–≤)

- `getKeyInfo()` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ
- `getBalance()` - —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å  
- `getUsageStats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- `getRateLimits()` - –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- `getAccountStatus()` - –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å
- `getModels()` - —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π (349)
- `getModelInfo()` - –¥–µ—Ç–∞–ª–∏ –º–æ–¥–µ–ª–∏
- `estimateCost()` - –æ—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- `hasEnoughBalance()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞

### ‚úÖ OpenRouter (3 –º–µ—Ç–æ–¥–∞)

- `text2text()` - —Ç–µ–∫—Å—Ç–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ‚úÖ
- `textStream()` - –ø–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ ‚úÖ
- `image2text()` - vision –º–æ–¥–µ–ª–∏ ‚úÖ
- `pdf2text()` - PDF –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚äó (—Ç—Ä–µ–±—É–µ—Ç —Ñ–∞–π–ª)
- `audio2text()` - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ ‚äó (—Ç—Ä–µ–±—É–µ—Ç —Ñ–∞–π–ª)

### ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è (4 –ø—Ä–æ–≤–µ—Ä–∫–∏)

- –ü—É—Å—Ç–∞—è –º–æ–¥–µ–ª—å ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –ü—É—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

---

## üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### #1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL (base_uri)

API –≤–æ–∑–≤—Ä–∞—â–∞–ª HTML –≤–º–µ—Å—Ç–æ JSON –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è `/` –≤ –∫–æ–Ω—Ü–µ base_uri.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤:**
- `src/OpenRouter.class.php` (—Å—Ç—Ä–æ–∫–∏ 29, 379, 423)
- `src/OpenRouterMetrics.class.php` (—Å—Ç—Ä–æ–∫–∏ 24, 481)

### #2: Regex –≤ unit-—Ç–µ—Å—Ç–∞—Ö

–¢–µ—Å—Ç—ã –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ–± –æ—à–∏–±–∫–∞—Ö.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤:**
- `tests/Unit/OpenRouterTest.php` (—Å—Ç—Ä–æ–∫–∞ 70)
- `tests/Unit/OpenRouterMetricsTest.php` (—Å—Ç—Ä–æ–∫–∞ 70)

---

## üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

### Unit-—Ç–µ—Å—Ç—ã (–±–µ–∑ API, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)

```bash
./vendor/bin/phpunit tests/Unit/OpenRouterTest.php          # 18 —Ç–µ—Å—Ç–æ–≤
./vendor/bin/phpunit tests/Unit/OpenRouterMetricsTest.php   # 18 —Ç–µ—Å—Ç–æ–≤
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (—Å API, ~$0.002)

```bash
php tests/Integration/OpenRouterFullTest.php "–≤–∞—à-api-–∫–ª—é—á"         # 14 —Ç–µ—Å—Ç–æ–≤
php tests/Integration/OpenRouterMultimodalTest.php "–≤–∞—à-api-–∫–ª—é—á"  # 1 —Ç–µ—Å—Ç
```

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –û–ø–µ—Ä–∞—Ü–∏—è | –ó–∞—Ç—Ä–∞—Ç—ã |
|----------|---------|
| Unit-—Ç–µ—Å—Ç—ã (36) | $0 |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ (14) | $0.00003 |
| –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω—ã–µ (1) | $0.00227 |
| **–ò–¢–û–ì–û** | **$0.0023** |

**–û—Å—Ç–∞—Ç–æ–∫: $0.9977 (99.77% –ª–∏–º–∏—Ç–∞)**

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```
2025-10-30T19:22:20+00:00 INFO HTTP –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω [POST chat/completions] –∫–æ–¥ 200 {
    "method":"POST",
    "uri":"chat/completions",
    "status_code":200,
    "duration":0.925,
    "body_size":532,
    "content_type":"application/json"
}
```

**–õ–æ–≥–∏:** `/logs_openrouter_test/`, `/logs_openrouter_multimodal/`

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `OPENROUTER_TESTING_COMPLETE.md` | –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ (—ç—Ç–æ—Ç —Ñ–∞–π–ª) |
| `OPENROUTER_TEST_SUMMARY_RU.md` | –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–≤–æ–¥–∫–∞ |
| `OPENROUTER_TEST_REPORT.md` | –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç |
| `OPENROUTER_FINAL_TEST_RESULTS.md` | –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã |

---

## ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –¢–∏–ø–∏–∑–∞—Ü–∏—è | ‚úÖ PHP 8.1+ strict |
| –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ 51 —Ç–µ—Å—Ç (100%) |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚úÖ PHPDoc —Ä—É—Å—Å–∫–∏–π |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | ‚úÖ –í—Å–µ —É—Ä–æ–≤–Ω–∏ |
| –í–∞–ª–∏–¥–∞—Ü–∏—è | ‚úÖ –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** ‚úÖ **–û–î–û–ë–†–ï–ù–û**

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –¥–æ–±–∞–≤–∏—Ç—å –¥–ª—è `getModels()` (TTL 1-24—á)
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –ø—Ä–æ–≤–µ—Ä—è—Ç—å –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–¥ –¥–æ—Ä–æ–≥–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
3. **CI/CD** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–µ—à–µ–≤—ã–µ –º–æ–¥–µ–ª–∏ –≤ –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞—Ö

---

## üéì –ü—Ä–∏–º–µ—Ä—ã

–°–º–æ—Ç—Ä–∏—Ç–µ:
- `/examples/openrouter_example.php` - –±–∞–∑–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
- `/examples/openrouter_metrics_example.php` - —Ä–∞–±–æ—Ç–∞ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- `/tests/Integration/` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

---

**–î–∞—Ç–∞:** 2025-10-30 | **–í–µ—Ä—Å–∏—è:** 1.0 | **–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û
