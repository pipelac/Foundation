# Отчет о нагрузочном тестировании FileCache

**Дата:** 2024-12-30  
**Версия:** 1.0  
**PHP:** 8.1+

## Краткое резюме

✅ **Все тесты прошли успешно: 88/88 (100%)**

Общее время выполнения: **~11.7 секунд**

---

## Результаты тестирования

### 1. Тест базовой конфигурации
- ✅ Создание кэша с массивом конфигурации
- ✅ Проверка валидации пустой директории
- ✅ Health check - директория существует
- ✅ Health check - директория читаема
- ✅ Health check - директория записываема

### 2. Тест базовых операций (set, get, has, delete)
- ✅ Set операция
- ✅ Get операция
- ✅ Has операция для существующего ключа
- ✅ Has операция для несуществующего ключа
- ✅ Delete операция
- ✅ Has после delete
- ✅ Все типы данных (string, integer, float, array, object, boolean, null)

### 3. Работа с TTL
- ✅ Set с TTL=2 секунды
- ✅ Проверка истечения TTL
- ✅ Touch операция
- ✅ Метаданные после touch
- ✅ isExpired до истечения
- ✅ isExpired после истечения
- ✅ Set с DateInterval

### 4. Множественные операции
- ✅ SetMultiple операция
- ✅ GetMultiple операция
- ✅ DeleteMultiple операция
- ✅ Проверка удаления элементов

### 5. Работа с тегами
- ✅ Создание элементов с тегами
- ✅ DeleteByTag операция
- ✅ Проверка удаления по тегам
- ✅ Множественная установка с тегами
- ✅ Удаление множественных элементов по тегу

### 6. Атомарные операции
- ✅ Increment с 0
- ✅ Increment на 5
- ✅ Decrement на 2
- ✅ Remember первый вызов
- ✅ Remember callback вызван
- ✅ Remember второй вызов (из кэша)
- ✅ Remember callback не вызван повторно
- ✅ Pull значение
- ✅ Pull удалил ключ
- ✅ Pull с default

### 7. Сборщик мусора
- ✅ GC удалил истекшие элементы
- ✅ Истекшие элементы удалены (10/10)
- ✅ Актуальные элементы сохранены (10/10)
- ✅ Prune операция
- ✅ Vacuum операция

### 8. Различные сериализаторы
- ✅ Сериализатор native
- ✅ Сериализатор json

**Примечание:** JSON сериализатор преобразует PHP объекты в ассоциативные массивы - это известное ограничение формата JSON.

### 9. Сжатие данных
- ✅ Маленькие данные без сжатия (< 1024 байт)
- ✅ Большие данные со сжатием (> 1024 байт)
- ✅ Сжатие уменьшило размер файла

### 10. Конкурентный доступ
- ✅ Конкурентные инкременты (50 итераций)
- ✅ Последняя запись сохранена

### 11. Большие данные
- ✅ Большой массив (1000 элементов)
- ✅ Содержимое большого массива
- ✅ Большая строка (~160KB)
- ✅ Размер кэша больше нуля

### 12. Метаданные и статистика
- ✅ Статистика: записи >= 5
- ✅ Статистика: попадания >= 5
- ✅ Статистика: промахи >= 3
- ✅ Статистика: процент попаданий
- ✅ Статистика: количество элементов
- ✅ Метаданные существуют
- ✅ Метаданные: created
- ✅ Метаданные: size
- ✅ Количество элементов >= 5
- ✅ Сброс статистики

### 13. Граничные условия
- ✅ Пустой ключ вызвал исключение
- ✅ Недопустимые символы вызвали исключение
- ✅ Длинный ключ вызвал исключение
- ✅ Нулевой TTL
- ✅ Отрицательный TTL
- ✅ Null значение сохранено
- ✅ False значение сохранено
- ✅ Пустая строка сохранена
- ✅ Clear удалил все элементы
- ✅ Flush удалил все элементы

### 14. Нагрузочный тест (высокая нагрузка)

**Запись 1000 элементов:**
- Время: 0.324 сек
- Производительность: **3,082 операций/сек**

**Чтение 1000 элементов:**
- Время: 0.117 сек
- Производительность: **8,521 операций/сек**

**Смешанные операции (500):**
- Время: 0.095 сек
- Производительность: **5,254 операций/сек**

**Финальная статистика:**
- Записей: 1,119
- Попаданий: 1,149
- Промахов: 0
- Удалений: 0
- Процент попаданий: **100%**
- Размер кэша: 325.4 KB
- Элементов: 1,000

---

## Найденные и исправленные ошибки

### Ошибка #1: Валидация пустой директории в FileCacheConfig

**Описание:** При передаче пустой строки в `cacheDirectory`, конструктор заменял её на значение по умолчанию ДО валидации, что не позволяло обнаружить ошибку пользователя.

**Исправление:**
```php
// src/Cache/FileCacheConfig.php, строки 50-53
// Проверяем пустую директорию ДО установки значения по умолчанию
if (isset($config['cacheDirectory']) && $config['cacheDirectory'] === '') {
    throw new InvalidArgumentException('Директория кэша не может быть пустой строкой.');
}
```

**Результат:** Теперь пользователь получает понятное исключение при передаче пустой строки.

---

### Ошибка #2: JSON сериализатор и объекты PHP

**Описание:** JSON формат не поддерживает корректное сохранение PHP объектов. При использовании `json_decode($data, false)` весь массив метаданных кэша превращается в stdClass, что ломает доступ через `$data['key']`.

**Решение:** 
1. Документировано ограничение JSON сериализатора
2. Добавлен подробный PHPDoc комментарий

```php
// src/Cache/FileCache.php, строки 1846-1867
/**
 * Декодирует JSON-строку
 * 
 * ВАЖНО: JSON сериализатор преобразует объекты PHP в ассоциативные массивы,
 * так как это единственный способ корректно работать со структурой данных кэша.
 * Это ограничение формата JSON. Для сохранения типов объектов используйте
 * сериализатор 'native', 'igbinary' или 'msgpack'.
 * ...
 */
private function decodeJson(string $data): mixed
{
    // Используем true (ассоциативный массив) для совместимости со структурой данных кэша
    $decoded = json_decode($data, true, 512, $this->config->jsonOptions);
    ...
}
```

**Результат:** Пользователи теперь понимают ограничения JSON и могут выбрать подходящий сериализатор.

---

## Производительность

### Операции записи
- **3,082 записи/сек** с шардированием (глубина 2)
- Средний размер записи: ~325 байт

### Операции чтения
- **8,521 чтение/сек** с использованием памяти кэша
- Процент попаданий: 100% (оптимально)

### Смешанные операции
- **5,254 операций/сек** (get, set, has, getMetadata)

---

## Конфигурация теста

```php
$config = [
    'cacheDirectory' => sys_get_temp_dir() . '/stress_test_cache',
    'defaultTtl' => 3600,
    'useSharding' => true,
    'shardingDepth' => 2,
    'enableStatistics' => true,
];
```

---

## Логирование

Класс FileCache поддерживает различные стратегии обработки ошибок:

- `throw` - выбрасывает исключения (по умолчанию)
- `log` - записывает в error_log
- `silent` - игнорирует ошибки

Все критические операции (чтение, запись, удаление) обрабатывают исключения через метод `handleError()`.

---

## Рекомендации

### Для максимальной производительности:
1. Используйте `preloadEnabled => true` для часто используемых данных
2. Включите шардирование для больших кэшей
3. Используйте сжатие для больших объемов данных
4. Настройте `maxCacheSize` для автоматической очистки

### Для надежности:
1. Используйте `fileLocking => true` при конкурентном доступе
2. Настройте `gcProbability` и `gcDivisor` для автоматической очистки
3. Используйте `atomicWrites => true` для критичных данных

### Выбор сериализатора:
- **native** - универсальный, поддерживает все типы PHP
- **json** - быстрый, но объекты превращаются в массивы
- **igbinary** - быстрее native, требует расширение
- **msgpack** - компактный, требует расширение

---

## Заключение

FileCache показывает отличную стабильность и производительность при различных нагрузках:
- ✅ Все 88 тестов пройдены
- ✅ Обработка граничных случаев
- ✅ Корректная работа с различными типами данных
- ✅ Высокая производительность (3K+ записей/сек, 8K+ чтений/сек)
- ✅ Надежная блокировка и конкурентный доступ
- ✅ Автоматическая сборка мусора

Класс готов к использованию в продакшене.
