# üîÑ –û—Ç—á–µ—Ç –æ–± –æ—Ç–∫–∞—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Ä–∞—Å—á–µ—Ç—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏

**–î–∞—Ç–∞:** 2025-11-11  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û–¢–ö–ê–¢ –í–´–ü–û–õ–ù–ï–ù

---

## üìã –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–ª–æ–∂–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:
```
final_cost = usage + usage_cache + usage_data + usage_web + usage_file
```

**–û—à–∏–±–∫–∞:** –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–ª–æ—Å—å, —á—Ç–æ `usage` - —ç—Ç–æ gross cost (–¥–æ —Å–∫–∏–¥–æ–∫), –∏ –Ω—É–∂–Ω–æ —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

---

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è

–°–æ–≥–ª–∞—Å–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

**–ü–æ–ª–µ `usage` –≤ OpenRouter API –£–ñ–ï —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å!**

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- `usage` - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π
- `usage_cache`, `usage_data` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª—è –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã—Ö —Å–∫–∏–¥–∫–∞—Ö
- `usage_web`, `usage_file` - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å—Ç–æ–∏–º–æ—Å—Ç–∏

---

## üîß –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–æ—Ç–∫–∞—Ç)

### 1. ‚úÖ OpenRouter.class.php

#### –£–¥–∞–ª–µ–Ω–æ:
- –ú–µ—Ç–æ–¥ `calculateFinalCost()` –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω

#### –ò–∑–º–µ–Ω–µ–Ω–æ –≤ `fetchGenerationMetrics()`:
```php
// –î–û (–Ω–µ–≤–µ—Ä–Ω–æ):
'final_cost' => $this->calculateFinalCost($usage, $usageCache, $usageData, $usageWeb, $usageFile),

// –ü–û–°–õ–ï (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
'final_cost' => $usage, // usage –£–ñ–ï —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
```

#### –ò–∑–º–µ–Ω–µ–Ω–æ –≤ `parseDetailedMetrics()`:
```php
// –î–û (–Ω–µ–≤–µ—Ä–Ω–æ):
'final_cost' => $this->calculateFinalCost(
    isset($response['usage']) ? (float)$response['usage'] : 0.0,
    isset($response['usage_cache']) ? (float)$response['usage_cache'] : 0.0,
    isset($response['usage_data']) ? (float)$response['usage_data'] : 0.0,
    isset($response['usage_web']) ? (float)$response['usage_web'] : 0.0,
    isset($response['usage_file']) ? (float)$response['usage_file'] : 0.0
),

// –ü–û–°–õ–ï (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
'final_cost' => isset($response['usage']) && is_numeric($response['usage']) 
    ? (float)$response['usage'] 
    : null,
```

### 2. ‚úÖ –°—Ö–µ–º–∞ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞

**–§–∞–π–ª:** `production/sql/migration_openrouter_metrics.sql`

```sql
-- –û–ë–ù–û–í–õ–ï–ù–´ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò:

usage_total DECIMAL(10, 8) NULL 
    COMMENT '–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –≤ USD (–ø–æ—Å–ª–µ –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π)',
    
usage_cache DECIMAL(10, 8) NULL 
    COMMENT '–°–∫–∏–¥–∫–∞ –∑–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –≤ USD (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è, —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)',
    
usage_data DECIMAL(10, 8) NULL 
    COMMENT '–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è OpenRouter –∑–∞ –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–º–ø—Ç–∞—Ö –≤ USD (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è, —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)',
    
usage_web DECIMAL(10, 8) NULL 
    COMMENT '–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫–∞ –≤ USD',
    
usage_file DECIMAL(10, 8) NULL 
    COMMENT '–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ USD',
    
final_cost DECIMAL(10, 8) NULL 
    COMMENT '–ö–æ–ø–∏—è usage_total –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å)',
```

### 3. ‚úÖ AIAnalysisTrait.php

**–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –ø–æ–ª–µ `final_cost` –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ—Ç `usage_total`.

---

## üìä –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –ø–æ–ª–µ–π

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|----------|
| `usage` (usage_total) | **–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å** | –£–ñ–ï –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π |
| `usage_cache` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–∏–¥–∫–µ | –°–∫–∏–¥–∫–∞ –∑–∞ –∫–µ—à (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è) |
| `usage_data` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ | –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ –æ–±—É—á–µ–Ω–∏–µ (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è) |
| `usage_web` | –î–æ–ø. —Å—Ç–æ–∏–º–æ—Å—Ç—å | –í–µ–±-–ø–æ–∏—Å–∫ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) |
| `usage_file` | –î–æ–ø. —Å—Ç–æ–∏–º–æ—Å—Ç—å | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) |
| `final_cost` | = `usage` | –ö–æ–ø–∏—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ |

---

## üí° –ü—Ä–∏–º–µ—Ä –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ API

```json
{
  "usage": 0.0003780711,        // ‚Üê –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å!
  "usage_cache": null,
  "usage_data": -0.0000038189,  // ‚Üê –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–∏–¥–∫–µ
  "usage_web": null,
  "usage_file": 0
}
```

**–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:**
- –í—ã –∑–∞–ø–ª–∞—Ç–∏–ª–∏: **$0.0003780711** (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å)
- OpenRouter –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é: $0.0000038189 (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
- –≠—Ç–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –£–ñ–ï —É—á—Ç–µ–Ω–∞ –≤ –ø–æ–ª–µ `usage`

**–ë–µ–∑ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –±—ã–ª–∞ –±—ã:**
```
Gross cost = usage - usage_data 
           = 0.0003780711 - (-0.0000038189) 
           = 0.00038189
```

–ù–æ –≤—ã –ø–ª–∞—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ **$0.0003780711** –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏!

---

## üéØ –ò—Ç–æ–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º—É–ª–∞:
```php
final_cost = usage;
```

–ü–æ–ª–µ `usage` –æ—Ç OpenRouter API —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —Å–∫–∏–¥–æ–∫ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (`usage_cache`, `usage_data`) —Å–ª—É–∂–∞—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–º, –∫–∞–∫–∏–µ —Å–∫–∏–¥–∫–∏ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.

---

## üìÅ –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

- ‚úÖ `src/BaseUtils/OpenRouter.class.php` - —É–¥–∞–ª–µ–Ω –º–µ—Ç–æ–¥ calculateFinalCost()
- ‚úÖ `production/sql/migration_openrouter_metrics.sql` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- ‚úÖ `production/ROLLBACK_REPORT.md` - —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞

–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å:

```
usage_total (—Ñ–∏–Ω–∞–ª—å–Ω–∞—è) = $0.0003780711
final_cost (–∫–æ–ø–∏—è)      = $0.0003780711  ‚úÖ

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–∏–¥–∫–∞—Ö:
- usage_cache = null (–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –∫–µ—à)
- usage_data = -$0.0000038189 (–±—ã–ª–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è)
```

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–û–¢–ö–ê–¢ –ó–ê–í–ï–†–®–ï–ù**

–¢–µ–ø–µ—Ä—å `final_cost` –ø—Ä–æ—Å—Ç–æ –∫–æ–ø–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ `usage`, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º, —Ç–∞–∫ –∫–∞–∫ OpenRouter API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –ø–æ–ª–µ `usage`.

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-11-11
