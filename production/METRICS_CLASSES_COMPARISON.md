# üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ –º–µ—Ç—Ä–∏–∫ OpenRouter

## –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–í –ø—Ä–æ–µ–∫—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –¥–≤–∞ –∫–ª–∞—Å—Å–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ OpenRouter:
1. **AIAnalysisTrait** (`src/Rss2Tlg/Pipeline/AIAnalysisTrait.php`)
2. **OpenRouterMetrics** (`src/BaseUtils/OpenRouterMetrics.class.php`)

---

## üéØ AIAnalysisTrait

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–¢—Ä–µ–π—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ AI –∞–Ω–∞–ª–∏–∑–∞ –≤ –ø–∞–π–ø–ª–∞–π–Ω—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (Summarization, Deduplication, Translation)

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ **–í—ã–∑–æ–≤ AI –º–æ–¥–µ–ª–µ–π** —Å fallback –∏ retry –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏
- ‚úÖ **–ó–∞–ø–∏—Å—å –º–µ—Ç—Ä–∏–∫ –≤ –ë–î** (`recordDetailedMetrics()`)
- ‚úÖ **–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏–∑ –ë–î** (`getDetailedMetrics()`, `getSummaryByPeriod()`, `getSummaryByModel()`)
- ‚úÖ **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º, –º–æ–¥–µ–ª—è–º, pipeline –º–æ–¥—É–ª—è–º
- ‚úÖ **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤** –¥–ª—è Claude –º–æ–¥–µ–ª–µ–π
- ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** –∏ retry –ª–æ–≥–∏–∫–∞

### –†–∞–±–æ—Ç–∞–µ—Ç —Å
- üìä –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î —Ç–∞–±–ª–∏—Ü–∞ `openrouter_metrics`
- ü§ñ OpenRouter API —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å `OpenRouter`

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `use AIAnalysisTrait` –≤ –∫–ª–∞—Å—Å–∞—Ö:
- `SummarizationModule`
- `DeduplicationService`
- –î—Ä—É–≥–∏–µ pipeline –º–æ–¥—É–ª–∏

---

## üîë OpenRouterMetrics

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ –∏ –º–æ–¥–µ–ª—è—Ö OpenRouter API

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª—é—á–µ** (`getKeyInfo()`)
- ‚úÖ **–ë–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞** (`getBalance()`)
- ‚úÖ **–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π** (`getModels()`)
- ‚úÖ **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏** (`getModelInfo()`)
- ‚úÖ **–û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏** –∑–∞–ø—Ä–æ—Å–∞ (`estimateCost()`)
- ‚úÖ **Rate limits** (`getRateLimits()`)
- ‚úÖ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** (`getUsageStats()`)

### –†–∞–±–æ—Ç–∞–µ—Ç —Å
- üåê –¢–æ–ª—å–∫–æ OpenRouter API endpoints:
  - `/auth/key`
  - `/models`
  - `/generation`

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
–°–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á

---

## ‚öñÔ∏è –ú–æ–∂–Ω–æ –ª–∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å?

### ‚ùå **–ù–ï–¢, –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –ù–ï —Å—Ç–æ–∏—Ç!**

### –ü—Ä–∏—á–∏–Ω—ã

#### 1. **–†–∞–∑–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏**
- **AIAnalysisTrait** - –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AI –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É
- **OpenRouterMetrics** - –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ä–∞–±–æ—Ç–∞ —Å OpenRouter API

#### 2. **–†–∞–∑–Ω—ã–µ –∑–æ–Ω—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**
- **AIAnalysisTrait** - —Ä–∞–±–æ—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –º–µ—Ç—Ä–∏–∫ + –≤—ã–∑–æ–≤ –º–æ–¥–µ–ª–µ–π
- **OpenRouterMetrics** - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ/–º–æ–¥–µ–ª—è—Ö

#### 3. **–†–∞–∑–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**
- **AIAnalysisTrait** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ runtime –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å)
- **OpenRouterMetrics** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞/–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—ç–ø–∏–∑–æ–¥–∏—á–µ—Å–∫–∏)

#### 4. **–†–∞–∑–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**
- **AIAnalysisTrait** - —Ç—Ä–µ–±—É–µ—Ç MySQL —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –º–µ—Ç—Ä–∏–∫
- **OpenRouterMetrics** - —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–ª—å–∫–æ HTTP –∫–ª–∏–µ–Ω—Ç

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –ò—Å–ø–æ–ª—å–∑—É–π AIAnalysisTrait –∫–æ–≥–¥–∞:
- ‚úÖ –ù—É–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å AI –º–æ–¥–µ–ª—å —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- ‚úÖ –ù—É–∂–Ω–æ –∑–∞–ø–∏—Å–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤—ã–∑–æ–≤–∞ –≤ –ë–î
- ‚úÖ –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –º–æ–¥–µ–ª–µ–π
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—à—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –ò—Å–ø–æ–ª—å–∑—É–π OpenRouterMetrics –∫–æ–≥–¥–∞:
- ‚úÖ –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞
- ‚úÖ –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
- ‚úÖ –ù—É–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –î–û –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- ‚úÖ –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å rate limits
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—à—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º–∏/–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏

---

## üìà –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (Final Cost)

### –§–æ—Ä–º—É–ª–∞
```
final_cost = usage_total - usage_data
```

### –ü–æ–ª—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- **usage_total** - –æ–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ (–¥–æ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π)
- **usage_cache** - —ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–æ–≤
- **usage_data** - –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è OpenRouter –∑–∞ –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–º–ø—Ç–∞—Ö
- **usage_file** - —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤
- **final_cost** - –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –≤—Å–µ—Ö –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–π

### –ì–¥–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è
–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ –º–µ—Ç–æ–¥–µ `OpenRouter::calculateFinalCost()` –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è:
1. –í `parseDetailedMetrics()` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ API
2. –í `fetchGenerationMetrics()` –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
3. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `openrouter_metrics` —á–µ—Ä–µ–∑ `AIAnalysisTrait::recordDetailedMetrics()`

---

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ

### –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ –ë–î
–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `final_cost` –≤ —Ç–∞–±–ª–∏—Ü—É `openrouter_metrics`:
```sql
final_cost DECIMAL(10, 8) NULL COMMENT '–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ (usage_total - usage_data) –≤ USD'
```

### –û–±–Ω–æ–≤–ª–µ–Ω OpenRouter.class.php
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `calculateFinalCost()`
- –û–±–Ω–æ–≤–ª–µ–Ω `parseDetailedMetrics()` –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è final_cost
- –û–±–Ω–æ–≤–ª–µ–Ω `fetchGenerationMetrics()` –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è final_cost

### –û–±–Ω–æ–≤–ª–µ–Ω AIAnalysisTrait.php
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `final_cost` –≤ SQL INSERT
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `:final_cost` –≤ params

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û–±–∞ –∫–ª–∞—Å—Å–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç —Å–≤–æ–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫:
- ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏—é Single Responsibility Principle
- ‚ùå –£—Å–ª–æ–∂–Ω–µ–Ω–∏—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚ùå –ü—Ä–æ–±–ª–µ–º–∞–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–¥–∞
- ‚ùå –ó–∞–ø—É—Ç–∞–Ω–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Å–ª–æ—è–º–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –û—Å—Ç–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å—ã —Ä–∞–∑–¥–µ–ª—å–Ω—ã–º–∏** ‚úÖ
