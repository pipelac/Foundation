# üîß –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è usage_data

**–î–∞—Ç–∞:** 2025-11-11  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –ò—Å—Ö–æ–¥–Ω–∞—è –æ—à–∏–±–∫–∞

–í –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –Ω–µ–≤–µ—Ä–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞:

```php
$finalCost = $usageTotal - $usageData;
```

### –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏

**OpenRouter API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–∏–¥–∫–∏ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –£–ñ–ï —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞–∫–æ–º!**

–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ API:
```json
{
  "usage": 0.0003780711,
  "usage_cache": null,
  "usage_data": -0.0000038189,  // ‚Üê –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–û–ï!
  "usage_web": null,
  "usage_file": 0
}
```

### –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ñ–æ—Ä–º—É–ª—ã `usage_total - usage_data`:
- usage_total = 0.0003780711
- usage_data = -0.0000038189
- **–ù–ï–í–ï–†–ù–û**: final_cost = 0.0003780711 - (-0.0000038189) = **0.00038189** ‚ùå

–≠—Ç–æ **–£–í–ï–õ–ò–ß–ò–í–ê–õ–û** —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ —É–º–µ–Ω—å—à–µ–Ω–∏—è!

---

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞

```php
final_cost = usage + usage_cache + usage_data + usage_web + usage_file
```

–í—Å–µ –ø–æ–ª—è —Å–æ —Å–∫–∏–¥–∫–∞–º–∏ —É–∂–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º–∏, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Å—É–º–º–∏—Ä—É–µ–º!

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç

- usage = 0.0003780711
- usage_data = -0.0000038189 (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è)
- **–ü–†–ê–í–ò–õ–¨–ù–û**: final_cost = 0.0003780711 + (-0.0000038189) = **0.0003742522** ‚úÖ

---

## üìã –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª–µ–π usage_*

–ü–æ –¥–∞–Ω–Ω—ã–º –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ API OpenRouter:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞–∫ |
|------|----------|------|
| `usage` (usage_total) | –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ | ‚úÖ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è |
| `usage_cache` | –°–∫–∏–¥–∫–∞ –∑–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ | ‚ö†Ô∏è **–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è** (—Å–∫–∏–¥–∫–∞) |
| `usage_data` | –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ–±—É—á–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–æ–º–ø—Ç–∞—Ö | ‚ö†Ô∏è **–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è** (–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è) |
| `usage_web` | –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫–∞ | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π |
| `usage_file` | –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ | ‚úÖ –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π |

### –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è

- **usage_cache**: OpenRouter –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∫–∏–¥–∫—É –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ (prompt caching)
- **usage_data**: OpenRouter –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç —á–∞—Å—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑—Ä–µ—à–∏–ª –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ —Å–≤–æ–∏—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö
- **usage_web**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –≤–µ–±-–ø–æ–∏—Å–∫ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- **usage_file**: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–æ–≤ (PDFs, images, etc)

---

## üîß –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. ‚úÖ OpenRouter.class.php

#### –î–æ:
```php
private function calculateFinalCost(float $usageTotal, float $usageData): ?float
{
    if ($usageTotal === 0.0 && $usageData === 0.0) {
        return null;
    }
    
    $finalCost = $usageTotal - $usageData;  // ‚ùå –ù–ï–í–ï–†–ù–û!
    return max(0.0, $finalCost);
}
```

#### –ü–æ—Å–ª–µ:
```php
private function calculateFinalCost(
    float $usage = 0.0,
    float $usageCache = 0.0,
    float $usageData = 0.0,
    float $usageWeb = 0.0,
    float $usageFile = 0.0
): ?float {
    if ($usage === 0.0) {
        return null;
    }
    
    // –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (—Å–∫–∏–¥–∫–∏ —É–∂–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ!)
    $finalCost = $usage + $usageCache + $usageData + $usageWeb + $usageFile;
    return $finalCost;
}
```

### 2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–∞

**–í fetchGenerationMetrics():**
```php
$usage = isset($metrics['usage']) ? (float)$metrics['usage'] : 0.0;
$usageCache = isset($metrics['usage_cache']) ? (float)$metrics['usage_cache'] : 0.0;
$usageData = isset($metrics['usage_data']) ? (float)$metrics['usage_data'] : 0.0;
$usageWeb = isset($metrics['usage_web']) ? (float)$metrics['usage_web'] : 0.0;
$usageFile = isset($metrics['usage_file']) ? (float)$metrics['usage_file'] : 0.0;

'final_cost' => $this->calculateFinalCost($usage, $usageCache, $usageData, $usageWeb, $usageFile),
```

**–í parseDetailedMetrics():**
```php
'final_cost' => $this->calculateFinalCost(
    isset($response['usage']) ? (float)$response['usage'] : 0.0,
    isset($response['usage_cache']) ? (float)$response['usage_cache'] : 0.0,
    isset($response['usage_data']) ? (float)$response['usage_data'] : 0.0,
    isset($response['usage_web']) ? (float)$response['usage_web'] : 0.0,
    isset($response['usage_file']) ? (float)$response['usage_file'] : 0.0
),
```

### 3. ‚úÖ –°—Ö–µ–º–∞ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞

**–§–∞–π–ª:** `production/sql/migration_openrouter_metrics.sql`

```sql
-- –°—Ç–æ–∏–º–æ—Å—Ç—å (USD)
usage_total DECIMAL(10, 8) NULL 
    COMMENT '–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –≤ USD (–¥–æ —Å–∫–∏–¥–æ–∫)',
usage_cache DECIMAL(10, 8) NULL 
    COMMENT '–°–∫–∏–¥–∫–∞ –∑–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –≤ USD (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è)',
usage_data DECIMAL(10, 8) NULL 
    COMMENT '–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è OpenRouter –∑–∞ –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–º–ø—Ç–∞—Ö –≤ USD (–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è)',
usage_web DECIMAL(10, 8) NULL 
    COMMENT '–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–µ–±-–ø–æ–∏—Å–∫–∞ –≤ USD',
usage_file DECIMAL(10, 8) NULL 
    COMMENT '–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ USD',
final_cost DECIMAL(10, 8) NULL 
    COMMENT '–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å = usage_total + usage_cache + usage_data + usage_web + usage_file –≤ USD',
```

### 4. ‚úÖ AIAnalysisTrait.php –æ–±–Ω–æ–≤–ª–µ–Ω

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `usage_web` –≤ SQL INSERT:

```php
INSERT INTO openrouter_metrics (
    ...,
    usage_total, usage_cache, usage_data, usage_web, usage_file, final_cost,
    ...
) VALUES (
    ...,
    :usage_total, :usage_cache, :usage_data, :usage_web, :usage_file, :final_cost,
    ...
)
```

### 5. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `production/sql/migration_add_usage_web.sql`

–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ `usage_web` –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É.

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

–ò–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ API –∑–∞–ø—Ä–æ—Å–∞:
```
usage:        $0.0003780711
usage_data:   $-0.0000038189
```

### –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞ (–ù–ï–í–ï–†–ù–ê–Ø):
```
final_cost = usage - usage_data
final_cost = 0.0003780711 - (-0.0000038189)
final_cost = 0.00038189 ‚ùå
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–æ–∏–º–æ—Å—Ç—å –£–í–ï–õ–ò–ß–ò–õ–ê–°–¨ –≤–º–µ—Å—Ç–æ —É–º–µ–Ω—å—à–µ–Ω–∏—è!

### –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø):
```
final_cost = usage + usage_data
final_cost = 0.0003780711 + (-0.0000038189)
final_cost = 0.0003742522 ‚úÖ
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°—Ç–æ–∏–º–æ—Å—Ç—å –£–ú–ï–ù–¨–®–ò–õ–ê–°–¨ –Ω–∞ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é!

### –≠–∫–æ–Ω–æ–º–∏—è
```
–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: $0.0000038189
–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏: (0.0000038189 / 0.0003780711) * 100 = 1.01%
```

---

## üéØ –í—ã–≤–æ–¥—ã

### –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –æ—à–∏–±–∫–∏

1. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: –ù–µ–≤–µ—Ä–Ω—ã–π —É—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ API –∑–∞–ø—Ä–æ—Å–æ–≤
2. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
3. **–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã —Ä–∞—Å—Ö–æ–¥–æ–≤

### –ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏

–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ OpenRouter API. OpenRouter –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–∫–∏–¥–∫–∏ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ —É–∂–µ —Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞–∫–æ–º.

### –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –≤ –±—É–¥—É—â–µ–º

1. ‚úÖ –¢—â–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API
2. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∑–Ω–∞–∫–∏ –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö
4. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

---

## üöÄ –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î

```bash
mysql -u rss2tlg -prss2tlg_pass_2025 rss2tlg_production < production/sql/migration_add_usage_web.sql
```

### 2. –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –≤ –ë–î —É–∂–µ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º `final_cost`, –≤—ã–ø–æ–ª–Ω–∏—Ç—å:

```sql
UPDATE openrouter_metrics
SET final_cost = usage_total 
    + COALESCE(usage_cache, 0) 
    + COALESCE(usage_data, 0) 
    + COALESCE(usage_web, 0) 
    + COALESCE(usage_file, 0)
WHERE final_cost IS NOT NULL;
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å—á–µ—Ç:

```bash
php production/test_production_infrastructure.php
```

---

## üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞

- ‚úÖ `METRICS_CLASSES_COMPARISON.md` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª–µ–π
- ‚úÖ `TASK_COMPLETION_REPORT.md` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏
- ‚úÖ `USAGE_DATA_FIX_REPORT.md` - —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

## ‚úÖ –°—Ç–∞—Ç—É—Å

**–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û**

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–µ—Å–µ–Ω—ã, –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-11-11

---

**üéØ –ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏:**

```
final_cost = usage + usage_cache + usage_data + usage_web + usage_file
```

**–ì–¥–µ –≤—Å–µ —Å–∫–∏–¥–∫–∏ (usage_cache, usage_data) —É–∂–µ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ!**
