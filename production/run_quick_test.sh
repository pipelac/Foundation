#!/bin/bash
# Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ ÑĞµÑ€Ğ¸Ñ Ğ¸Ğ· 5 Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ² RSS Ingest
# Ğ˜Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»: 10 ÑĞµĞºÑƒĞ½Ğ´

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        RSS INGEST - Ğ‘Ğ«Ğ¡Ğ¢Ğ ĞĞ¯ Ğ¡Ğ•Ğ Ğ˜Ğ¯ Ğ˜Ğ— 5 Ğ—ĞĞŸĞ£Ğ¡ĞšĞĞ’              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

for i in {1..5}; do
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”„ Ğ—ĞĞŸĞ£Ğ¡Ğš #$i Ğ¸Ğ· 5"
    echo "ğŸ• Ğ’Ñ€ĞµĞ¼Ñ: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
    php /home/engine/project/production/rss_ingest.php
    
    echo ""
    echo "âœ… Ğ—Ğ°Ğ¿ÑƒÑĞº #$i Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½"
    echo ""
    
    # ĞŸĞ°ÑƒĞ·Ğ° Ğ¿ĞµÑ€ĞµĞ´ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼ (ĞºÑ€Ğ¾Ğ¼Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾)
    if [ $i -lt 5 ]; then
        echo "â³ ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ 10 ÑĞµĞºÑƒĞ½Ğ´ Ğ´Ğ¾ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°..."
        echo ""
        sleep 10
    fi
done

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ‰ Ğ’Ğ¡Ğ• 5 Ğ—ĞĞŸĞ£Ğ¡ĞšĞĞ’ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ«!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ‘Ğ”..."
mysql -u rss2tlg_user -prss2tlg_password_2024 rss2tlg -e "
SELECT 
    f.name as 'Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº',
    COUNT(i.id) as 'Ğ’ÑĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹',
    MAX(i.created_at) as 'ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ÑÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ'
FROM rss2tlg_feeds f
LEFT JOIN rss2tlg_items i ON f.id = i.feed_id
WHERE f.enabled = 1
GROUP BY f.id, f.name
ORDER BY f.id;
"

echo ""
echo "ğŸ“Š Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ²..."
mysql -u rss2tlg_user -prss2tlg_password_2024 rss2tlg -e "
SELECT 
    feed_id,
    last_status,
    error_count,
    fetched_at
FROM rss2tlg_feed_state
ORDER BY feed_id;
"

echo ""
echo "ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼..."
mysql -u rss2tlg_user -prss2tlg_password_2024 rss2tlg -e "
SELECT 
    feed_id,
    extraction_status,
    COUNT(*) as count
FROM rss2tlg_items
GROUP BY feed_id, extraction_status
ORDER BY feed_id, extraction_status;
"

echo ""
echo "âœ… Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!"
