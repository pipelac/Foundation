<?php

declare(strict_types=1);

require_once __DIR__ . '/../../../autoload.php';

use App\Component\OpenRouter;
use App\Component\Logger;
use App\Component\Exception\OpenRouterException;

/**
 * –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–µ—Ç–æ–¥–æ–≤ audio2text –∏ text2audio
 * –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ OpenRouter API
 */

echo "=== –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã —Å –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ OpenRouter API ===\n\n";

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
$logger = new Logger([
    'directory' => __DIR__ . '/../logs',
    'file_name' => 'openrouter_audio.log',
]);

$openRouter = new OpenRouter([
    'api_key' => getenv('OPENROUTER_API_KEY') ?: 'your-api-key-here',
    'app_name' => 'AudioExample',
    'timeout' => 60,
], $logger);

// ===========================================
// –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ (text2audio)
// ===========================================
echo "–ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤—ã–π —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏\n";
echo str_repeat('-', 50) . "\n";

try {
    $text = '–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏.';
    
    echo "–¢–µ–∫—Å—Ç –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞: \"$text\"\n";
    echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ...\n";
    
    $audioData = $openRouter->text2audio(
        'openai/tts-1',      // –ú–æ–¥–µ–ª—å
        $text,                // –¢–µ–∫—Å—Ç
        'alloy'              // –ì–æ–ª–æ—Å
    );
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    $outputPath = __DIR__ . '/../temp/example1_basic.mp3';
    $dir = dirname($outputPath);
    if (!is_dir($dir)) {
        mkdir($dir, 0755, true);
    }
    
    file_put_contents($outputPath, $audioData);
    
    echo "‚úì –£—Å–ø–µ—à–Ω–æ!\n";
    echo "  –§–∞–π–ª: $outputPath\n";
    echo "  –†–∞–∑–º–µ—Ä: " . number_format(strlen($audioData) / 1024, 2) . " –ö–ë\n\n";
    
} catch (OpenRouterException $e) {
    echo "‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n\n";
}

// ===========================================
// –ü—Ä–∏–º–µ—Ä 2: –°–∏–Ω—Ç–µ–∑ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
// ===========================================
echo "–ü—Ä–∏–º–µ—Ä 2: –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏\n";
echo str_repeat('-', 50) . "\n";

try {
    $text = '–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–Ω–µ—Å–µ–Ω —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é.';
    
    echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:\n";
    echo "  - –ì–æ–ª–æ—Å: nova\n";
    echo "  - –°–∫–æ—Ä–æ—Å—Ç—å: 1.25x\n";
    echo "  - –§–æ—Ä–º–∞—Ç: mp3\n";
    
    $audioData = $openRouter->text2audio(
        'openai/tts-1',
        $text,
        'nova',
        [
            'speed' => 1.25,
            'response_format' => 'mp3',
        ]
    );
    
    $outputPath = __DIR__ . '/../temp/example2_parameters.mp3';
    file_put_contents($outputPath, $audioData);
    
    echo "‚úì –£—Å–ø–µ—à–Ω–æ!\n";
    echo "  –§–∞–π–ª: $outputPath\n\n";
    
} catch (OpenRouterException $e) {
    echo "‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n\n";
}

// ===========================================
// –ü—Ä–∏–º–µ—Ä 3: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤
// ===========================================
echo "–ü—Ä–∏–º–µ—Ä 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å —Ä–∞–∑–Ω—ã–º–∏ –≥–æ–ª–æ—Å–∞–º–∏\n";
echo str_repeat('-', 50) . "\n";

$voices = [
    'alloy' => '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –≥–æ–ª–æ—Å',
    'echo' => '–ì–æ–ª–æ—Å —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º –∑–≤—É—á–∞–Ω–∏–µ–º',
    'nova' => '–Ø—Ä–∫–∏–π —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π –≥–æ–ª–æ—Å',
];

$text = '–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤.';

foreach ($voices as $voice => $description) {
    try {
        echo "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è: $voice ($description)...\n";
        
        $audioData = $openRouter->text2audio(
            'openai/tts-1',
            $text,
            $voice
        );
        
        $outputPath = __DIR__ . "/../temp/example3_voice_$voice.mp3";
        file_put_contents($outputPath, $audioData);
        
        echo "  ‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: $outputPath\n";
        
    } catch (OpenRouterException $e) {
        echo "  ‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n";
    }
}
echo "\n";

// ===========================================
// –ü—Ä–∏–º–µ—Ä 4: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ (audio2text)
// ===========================================
echo "–ü—Ä–∏–º–µ—Ä 4: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏–∑ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞\n";
echo str_repeat('-', 50) . "\n";

try {
    // –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º —Ç–µ—Å—Ç–æ–≤—ã–π –∞—É–¥–∏–æ—Ñ–∞–π–ª
    $testText = '–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Ñ—Ä–∞–∑–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏.';
    
    echo "–®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞...\n";
    $audioData = $openRouter->text2audio(
        'openai/tts-1',
        $testText,
        'shimmer'
    );
    
    $testAudioPath = __DIR__ . '/../temp/example4_test_audio.mp3';
    file_put_contents($testAudioPath, $audioData);
    echo "  ‚úì –°–æ–∑–¥–∞–Ω: $testAudioPath\n";
    
    echo "–®–∞–≥ 2: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏–∑ —Ñ–∞–π–ª–∞...\n";
    echo "  –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –≠—Ç–æ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É API.\n";
    
    // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
    // $transcription = $openRouter->audio2text(
    //     'openai/whisper-1',
    //     $testAudioPath,
    //     ['language' => 'ru']
    // );
    // 
    // echo "  –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç: \"$testText\"\n";
    // echo "  –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: \"$transcription\"\n";
    // echo "  ‚úì –£—Å–ø–µ—à–Ω–æ!\n\n";
    
    echo "  ‚äò –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)\n\n";
    
} catch (OpenRouterException $e) {
    echo "  ‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n\n";
}

// ===========================================
// –ü—Ä–∏–º–µ—Ä 5: –†–∞–±–æ—Ç–∞ —Å URL –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤
// ===========================================
echo "–ü—Ä–∏–º–µ—Ä 5: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏–∑ URL\n";
echo str_repeat('-', 50) . "\n";

try {
    $audioUrl = 'https://example.com/sample-audio.mp3';
    
    echo "URL –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞: $audioUrl\n";
    echo "–ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–º–µ—Ä–∞ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π URL –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞.\n";
    
    // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
    // $transcription = $openRouter->audio2text(
    //     'openai/whisper-1',
    //     $audioUrl,
    //     [
    //         'language' => 'ru',
    //         'temperature' => 0.0,
    //     ]
    // );
    // 
    // echo "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è:\n";
    // echo $transcription . "\n";
    // echo "‚úì –£—Å–ø–µ—à–Ω–æ!\n\n";
    
    echo "‚äò –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–ø—É—â–µ–Ω (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π URL)\n\n";
    
} catch (OpenRouterException $e) {
    echo "‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n\n";
}

// ===========================================
// –ü—Ä–∏–º–µ—Ä 6: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
// ===========================================
echo "–ü—Ä–∏–º–µ—Ä 6: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏\n";
echo str_repeat('-', 50) . "\n";

try {
    // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–≤–∞—Ç—å –º–µ—Ç–æ–¥ —Å –ø—É—Å—Ç—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    $openRouter->text2audio('', '', '');
    echo "–≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è\n";
    
} catch (OpenRouterException $e) {
    echo "‚úì –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞ –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:\n";
    echo "  " . $e->getMessage() . "\n\n";
}

// ===========================================
// –ò—Ç–æ–≥–∏
// ===========================================
echo str_repeat('=', 50) . "\n";
echo "–í—Å–µ –ø—Ä–∏–º–µ—Ä—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!\n\n";

echo "üìÇ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:\n";
$tempDir = __DIR__ . '/../temp';
if (is_dir($tempDir)) {
    $files = glob($tempDir . '/example*.mp3');
    foreach ($files as $file) {
        $size = filesize($file);
        echo "  - " . basename($file) . " (" . number_format($size / 1024, 2) . " –ö–ë)\n";
    }
} else {
    echo "  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è temp –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\n";
}

echo "\nüí° –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:\n";
echo "  ‚úì text2audio - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Ä–µ—á—å\n";
echo "  ‚úì audio2text - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏–∑ –∞—É–¥–∏–æ\n";
echo "  ‚úì –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤ (alloy, echo, fable, onyx, nova, shimmer)\n";
echo "  ‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–µ—á–∏ (0.25 - 4.0)\n";
echo "  ‚úì –†–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∞—É–¥–∏–æ (mp3, opus, aac, flac)\n";
echo "  ‚úì –†–∞–±–æ—Ç–∞ —Å URL –∏ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏\n";
echo "  ‚úì –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π\n";

echo "\nüìã –õ–æ–≥–∏: " . __DIR__ . "/../logs/openrouter_audio.log\n";
