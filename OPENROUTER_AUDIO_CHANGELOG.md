# Changelog: Добавление методов audio2text и text2audio

## Дата: 2024

### Новая функциональность

#### 1. Метод text2audio

**Описание:** Преобразует текст в речь (Text-to-Speech)

**Сигнатура:**
```php
public function text2audio(
    string $model, 
    string $text, 
    string $voice, 
    array $options = []
): string
```

**Параметры:**
- `$model` - Модель синтеза речи (например, "openai/tts-1", "openai/tts-1-hd")
- `$text` - Текст для преобразования в речь
- `$voice` - Голос для синтеза (alloy, echo, fable, onyx, nova, shimmer)
- `$options` - Дополнительные параметры:
  - `speed` (float): Скорость речи (0.25 - 4.0)
  - `response_format` (string): Формат аудио (mp3, opus, aac, flac)

**Возвращает:** Бинарное содержимое аудиофайла

**Исключения:**
- `OpenRouterValidationException` - Если параметры невалидны
- `OpenRouterApiException` - Если API вернул ошибку
- `OpenRouterException` - Если не удалось получить аудиоданные

**Пример использования:**
```php
$audioData = $openRouter->text2audio(
    'openai/tts-1',
    'Привет! Это пример синтеза речи.',
    'alloy',
    [
        'speed' => 1.0,
        'response_format' => 'mp3',
    ]
);

file_put_contents('output.mp3', $audioData);
```

#### 2. Метод audio2text (уже существовал)

**Описание:** Распознает речь из аудиофайла (Speech-to-Text)

**Статус:** Метод уже существовал в классе, добавлены примеры использования

### Изменения в коде

#### Файл: `src/OpenRouter.class.php`

1. **Добавлен метод text2audio** (строки 257-313)
   - Полная типизация параметров и возвращаемого значения
   - PHPDoc документация на русском языке
   - Валидация всех параметров
   - Обработка исключений
   - Логирование ошибок

2. **Обновлен PHPDoc класса** (строка 21)
   - Добавлено упоминание метода text2audio в список функций

#### Endpoint: `/audio/speech`
- Используется стандартный OpenAI endpoint для синтеза речи
- Параметры передаются в JSON формате
- Возвращает бинарные аудио данные

### Новые файлы

#### 1. `examples/openrouter_example.php`

Полный набор примеров использования всех методов OpenRouter:
- text2text - текстовая генерация
- text2image - генерация изображений
- image2text - распознавание изображений
- audio2text - распознавание речи
- **text2audio - синтез речи** (НОВОЕ)
- pdf2text - извлечение текста из PDF
- textStream - потоковая передача

Примеры включают:
- Базовое использование
- Работу с параметрами
- Различные голоса
- Различные скорости
- Различные форматы аудио
- Обработку ошибок
- Работу с локальными файлами и URL

#### 2. `examples/openrouter_audio_example.php`

Упрощенные примеры специально для работы с аудио:
- Базовый синтез речи
- Синтез с параметрами
- Сравнение различных голосов
- Распознавание речи
- Работа с URL
- Обработка ошибок

Всего 6 практических примеров с подробными комментариями.

#### 3. `docs/OPENROUTER_AUDIO.md`

Полная документация по методам audio2text и text2audio:
- Подробное описание параметров
- Все доступные опции
- Примеры использования
- Обработка исключений
- Лучшие практики:
  - Валидация текста
  - Кэширование аудио
  - Логирование
  - Поддержка форматов
  - Retry логика

#### 4. `OPENROUTER_AUDIO_CHANGELOG.md`

Этот файл - описание всех изменений.

### Обновленные файлы

#### `README.md`

Обновлены разделы:
- Список функций OpenRouter (добавлен text2audio)
- Примеры использования (добавлен пример text2audio)

### Стиль кода

Все изменения следуют установленным стандартам:
- ✅ Строгая типизация всех параметров и возвращаемых значений
- ✅ PHPDoc документация на русском языке
- ✅ Описательные имена методов и переменных
- ✅ Обработка исключений на каждом уровне
- ✅ Минимальная сложность кода
- ✅ PHP 8.1+ синтаксис
- ✅ PSR-12 стандарты

### Технические детали

#### Метод text2audio

1. **Валидация входных данных:**
   ```php
   $this->validateNotEmpty($model, 'model');
   $this->validateNotEmpty($text, 'text');
   $this->validateNotEmpty($voice, 'voice');
   ```

2. **Формирование payload:**
   ```php
   $payload = array_merge([
       'model' => $model,
       'input' => $text,
       'voice' => $voice,
   ], $options);
   ```

3. **HTTP запрос:**
   - Метод: POST
   - Endpoint: `/audio/speech`
   - Content-Type: `application/json`
   - Авторизация: Bearer token

4. **Обработка ответа:**
   - Проверка статус-кода
   - Логирование ошибок
   - Валидация содержимого
   - Возврат бинарных данных

### Поддерживаемые голоса

| Голос | Описание |
|-------|----------|
| alloy | Универсальный нейтральный голос |
| echo | Голос с характерным звучанием |
| fable | Выразительный и эмоциональный |
| onyx | Глубокий и насыщенный |
| nova | Яркий и энергичный |
| shimmer | Мягкий и приятный |

### Поддерживаемые форматы аудио

- mp3 (по умолчанию)
- opus
- aac
- flac

### Диапазон скорости

- Минимум: 0.25x
- По умолчанию: 1.0x
- Максимум: 4.0x

### Примеры использования

#### Простейший вариант:
```php
$audioData = $openRouter->text2audio('openai/tts-1', 'Привет!', 'alloy');
file_put_contents('output.mp3', $audioData);
```

#### С настройками:
```php
$audioData = $openRouter->text2audio(
    'openai/tts-1-hd',
    'Это высококачественное аудио с повышенной скоростью.',
    'nova',
    [
        'speed' => 1.5,
        'response_format' => 'opus',
    ]
);
file_put_contents('output.opus', $audioData);
```

#### Цикл text2audio -> audio2text:
```php
// Генерация
$originalText = 'Тестовая фраза';
$audioData = $openRouter->text2audio('openai/tts-1', $originalText, 'shimmer');
file_put_contents('test.mp3', $audioData);

// Распознавание
$transcription = $openRouter->audio2text('openai/whisper-1', 'test.mp3');
echo "Оригинал: $originalText\n";
echo "Распознано: $transcription\n";
```

### Тестирование

Все примеры можно запустить:

```bash
# Полный набор примеров
php examples/openrouter_example.php

# Только примеры с аудио
php examples/openrouter_audio_example.php
```

**Примечание:** Для работы примеров необходим API ключ OpenRouter:
```bash
export OPENROUTER_API_KEY="your-api-key-here"
```

### Обратная совместимость

✅ Все изменения обратно совместимы:
- Существующие методы не изменены
- Добавлен только новый метод text2audio
- Обновлена документация
- Добавлены примеры

### Зависимости

Метод использует существующие компоненты:
- `Http` класс для HTTP запросов
- `Logger` для логирования (опционально)
- Классы исключений из `App\Component\Exception\`

### Логирование

При возникновении ошибок автоматически логируются:
- Статус-код ответа
- Тело ответа сервера
- Контекст запроса

Пример лога:
```
[ERROR] Сервер OpenRouter вернул ошибку при синтезе речи
{
    "status_code": 400,
    "response": "{\"error\": \"Invalid voice parameter\"}"
}
```

### Производительность

**Размер аудиофайлов (примерно):**
- mp3 @ 128kbps: ~1 КБ на секунду
- opus @ 64kbps: ~0.5 КБ на секунду
- flac (lossless): ~5-8 КБ на секунду

**Время генерации:**
- Зависит от длины текста
- Обычно 1-3 секунды для фразы из 20-30 слов

### Ограничения

1. **Максимальная длина текста:** ~4096 символов (зависит от модели)
2. **Rate limits:** Зависят от тарифного плана OpenRouter
3. **Размер файла:** Зависит от длины текста и формата

### TODO (будущие улучшения)

- [ ] Добавить поддержку разбиения длинных текстов на части
- [ ] Кэширование сгенерированных аудио
- [ ] Batch обработка нескольких текстов
- [ ] Поддержка дополнительных параметров (pitch, emotion)
- [ ] Интеграция с другими TTS провайдерами

### Известные проблемы

Нет известных проблем на момент релиза.

### Ссылки

- [OpenRouter API Documentation](https://openrouter.ai/docs)
- [OpenAI TTS API](https://platform.openai.com/docs/guides/text-to-speech)
- [Примеры использования](examples/openrouter_audio_example.php)
- [Полная документация](docs/OPENROUTER_AUDIO.md)

---

**Версия:** 1.0.0
**Дата:** 2024
**Автор:** AI Code Assistant
**Требования:** PHP 8.1+
