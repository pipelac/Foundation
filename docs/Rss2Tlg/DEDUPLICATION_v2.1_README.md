# üöÄ DeduplicationService v2.1 - Preliminary Similarity Filter

**–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** 2025-11-10  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready

---

## üéØ –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?

–í –≤–µ—Ä—Å–∏–∏ 2.1 –¥–æ–±–∞–≤–ª–µ–Ω–∞ **–¥–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** –¥–ª—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–î–æ (v2.0):**
```
50 –Ω–æ–≤–æ—Å—Ç–µ–π ‚Üí AI –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö 50 ‚Üí 10,000 —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí $0.02
```

**–ü–æ—Å–ª–µ (v2.1):**
```
50 –Ω–æ–≤–æ—Å—Ç–µ–π ‚Üí Preliminary filter ‚Üí 10-15 –ª—É—á—à–∏—Ö ‚Üí AI –∞–Ω–∞–ª–∏–∑ ‚Üí 2,000 —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí $0.004
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚Üì80% —Ç–æ–∫–µ–Ω–æ–≤, ‚Üì75% –≤—Ä–µ–º–µ–Ω–∏, ‚Üì80% —Å—Ç–æ–∏–º–æ—Å—Ç–∏!

---

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –≠—Ç–∞–ø 1: Preliminary Similarity Check

**–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** —Å—Ö–æ–∂–µ—Å—Ç–∏ —á–µ—Ä–µ–∑ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

1. **Jaccard Similarity** –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤ (entities, keywords)
   ```
   J(A,B) = |A ‚à© B| / |A ‚à™ B|
   ```

2. **Cosine Similarity** –¥–ª—è —Ç–µ–∫—Å—Ç–∞ (core_event)
   ```
   cos(A,B) = (A¬∑B) / (||A|| * ||B||)
   ```

3. **Weighted Average:**
   ```
   similarity = jaccard(entities) * 40% + 
                cosine(event) * 30% + 
                jaccard(keywords) * 30%
   ```

### –≠—Ç–∞–ø 2: AI Analysis (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö)

–ï—Å–ª–∏ `preliminary_similarity >= 60%`, —Ç–æ:
- –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ö–æ–∂–µ—Å—Ç–∏
- –ë–µ—Ä–µ–º —Ç–æ–ø-10 —Å–∞–º—ã—Ö –ø–æ—Ö–æ–∂–∏—Ö
- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏—Ö –≤ AI –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

–ï—Å–ª–∏ `preliminary_similarity < 60%`:
- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º AI –∞–Ω–∞–ª–∏–∑
- –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É–Ω–∏–∫–∞–ª—å–Ω—É—é –Ω–æ–≤–æ—Å—Ç—å
- –≠–∫–æ–Ω–æ–º–∏–º —Ç–æ–∫–µ–Ω—ã –∏ –≤—Ä–µ–º—è!

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```json
{
  "max_preliminary_comparisons": 50,      
  "preliminary_similarity_threshold": 60, 
  "max_ai_comparisons": 10,               
  "similarity_threshold": 70              
}
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `max_preliminary_comparisons` | 50 | –°–∫–æ–ª—å–∫–æ –Ω–æ–≤–æ—Å—Ç–µ–π –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ë–î –¥–ª—è preliminary check |
| `preliminary_similarity_threshold` | 60 | –ü–æ—Ä–æ–≥ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (0-100). –ï—Å–ª–∏ < 60% ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º AI |
| `max_ai_comparisons` | 10 | –°–∫–æ–ª—å–∫–æ —Ç–æ–ø-–Ω–æ–≤–æ—Å—Ç–µ–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ AI |
| `similarity_threshold` | 70 | –ü–æ—Ä–æ–≥ –¥—É–±–ª–∏–∫–∞—Ç–∞ –æ—Ç AI (0-100) |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

**–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º** (–º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤):
```json
{
  "preliminary_similarity_threshold": 50,
  "max_ai_comparisons": 15,
  "similarity_threshold": 75
}
```

**–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
```json
{
  "preliminary_similarity_threshold": 60,
  "max_ai_comparisons": 10,
  "similarity_threshold": 70
}
```

**–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º** (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è):
```json
{
  "preliminary_similarity_threshold": 70,
  "max_ai_comparisons": 5,
  "similarity_threshold": 80
}
```

---

## üìä –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:

```php
$metrics = $service->getMetrics();

echo "Preliminary checks: " . $metrics['preliminary_checks'] . "\n";
echo "Filtered: " . $metrics['preliminary_filtered'] . "\n";
echo "AI skipped: " . $metrics['ai_skipped'] . "\n";

$filterRate = ($metrics['preliminary_filtered'] / $metrics['preliminary_checks']) * 100;
echo "Filter rate: " . round($filterRate, 1) . "%\n";
```

**–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:**
```
Preliminary checks: 450
Filtered: 380
AI skipped: 3
Filter rate: 84.4%
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

```bash
php tests/test_preliminary_similarity_logic.php
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ 5/5 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ

### Integration —Ç–µ—Å—Ç—ã

```bash
php tests/test_deduplication_preliminary.php
```

–¢—Ä–µ–±—É–µ—Ç—Å—è: MariaDB + –¥–∞–Ω–Ω—ã–µ –≤ `rss2tlg_summarization`

---

## üîç Bilingual Fields

Preliminary filter –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω—ã–µ –ø–æ–ª—è** –¥–ª—è –∫—Ä–æ—Å—Å-—è–∑—ã–∫–æ–≤–æ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `dedup_canonical_entities_en` | –°—É—â–Ω–æ—Å—Ç–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (JSON) |
| `dedup_core_event_en` | –°–æ–±—ã—Ç–∏–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (TEXT) |
| `keywords_en` | –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º (JSON) |

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ª—é–±–æ–≥–æ —è–∑—ã–∫–∞ (ru, en, zh, etc)!

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –¢–µ—Å—Ç–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (unit tests)

| –¢–µ—Å—Ç | –°—Ö–æ–∂–µ—Å—Ç—å | –°—Ç–∞—Ç—É—Å |
|------|----------|--------|
| –ò–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ | 100% | ‚úÖ PASS |
| –ü–æ—Ö–æ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ | 38% | ‚úÖ PASS |
| –†–∞–∑–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ | 5% | ‚úÖ PASS |
| –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ | 22% | ‚úÖ PASS |
| –ü—É—Å—Ç—ã–µ –ø–æ–ª—è | 0% | ‚úÖ PASS |

**–í—ã–≤–æ–¥:** –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!

### –û–∂–∏–¥–∞–µ–º–∞—è —ç–∫–æ–Ω–æ–º–∏—è (production)

–ü—Ä–∏ threshold = 60% –∏ —Ç–∏–ø–∏—á–Ω–æ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π:

- **–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ:** ~75-85% –Ω–æ–≤–æ—Å—Ç–µ–π
- **–≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤:** ~80%
- **–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏:** ~75%
- **–≠–∫–æ–Ω–æ–º–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏:** ~80%

---

## üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è —Å v2.0

### 1. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `production/configs/deduplication.json`:

```json
{
  "max_preliminary_comparisons": 50,
  "preliminary_similarity_threshold": 60,
  "max_ai_comparisons": 10
}
```

### 2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥

–ö–æ–¥ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Å–µ—Ä–≤–∏—Å —Å–æ–≤–º–µ—Å—Ç–∏–º —Å v2.0!

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω—ã–µ –ø–æ–ª—è

–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ –ë–î –µ—Å—Ç—å –ø–æ–ª—è `_en`:

```sql
SHOW COLUMNS FROM rss2tlg_summarization LIKE '%_en';
```

–ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é:

```bash
mysql -u rss2tlg_user -prss2tlg_password_2024 rss2tlg < production/sql/migration_add_en_fields.sql
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
php tests/test_preliminary_similarity_logic.php
```

---

## üí° Best Practices

### 1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ `filter_rate` - –µ—Å–ª–∏ < 50%, –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ—Ä–æ–≥ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π:

```php
$filterRate = ($metrics['preliminary_filtered'] / $metrics['preliminary_checks']) * 100;
if ($filterRate < 50) {
    $logger->warning("Low filter rate: {$filterRate}%");
}
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–æ–≤

–ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ:

```
–ù–µ–¥–µ–ª—è 1: threshold = 50, max_ai = 15
–ù–µ–¥–µ–ª—è 2: threshold = 55, max_ai = 12
–ù–µ–¥–µ–ª—è 3: threshold = 60, max_ai = 10 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```

### 3. A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å v2.0:

```php
// v2.0 (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞)
$configV20 = ['preliminary_similarity_threshold' => 0];

// v2.1 (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º)
$configV21 = ['preliminary_similarity_threshold' => 60];
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç–µ `preliminary_similarity_threshold`:
```json
{ "preliminary_similarity_threshold": 50 }
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á—å—Ç–µ `preliminary_similarity_threshold`:
```json
{ "preliminary_similarity_threshold": 70 }
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç–µ `max_preliminary_comparisons`:
```json
{ "max_preliminary_comparisons": 30 }
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [Pipeline_Deduplication_README.md](./Pipeline_Deduplication_README.md)
- **–û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:** [DEDUPLICATION_PRELIMINARY_FILTER_TEST_REPORT.md](./DEDUPLICATION_PRELIMINARY_FILTER_TEST_REPORT.md)
- **–ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** [DEDUPLICATION_PRELIMINARY_SIMILARITY_PLAN.md](./DEDUPLICATION_PRELIMINARY_SIMILARITY_PLAN.md)

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

- [x] –ö–æ–¥ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] Unit —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (5/5)
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞–ø–∏—Å–∞–Ω–∞
- [ ] Integration —Ç–µ—Å—Ç—ã (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ë–î)
- [ ] Production —Ç–µ—Å—Ç—ã (—Ç—Ä–µ–±—É—é—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 2025-11-10  
**–í–µ—Ä—Å–∏—è:** 1.0
