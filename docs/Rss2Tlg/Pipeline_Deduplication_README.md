# üîç DeduplicationService - –ú–æ–¥—É–ª—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π

**–°—Ç–∞—Ç—É—Å:** ‚úÖ PRODUCTION READY  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 2025-11-08

---

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

DeduplicationService ‚Äî –≤—Ç–æ—Ä–æ–π —ç—Ç–∞–ø AI Pipeline –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π. –ú–æ–¥—É–ª—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å—Ä–µ–¥–∏ —É–∂–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è AI –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–ª—é—á–µ–≤—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ —Å–æ–±—ã—Ç–∏–π.

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

1. **AI-–∞–Ω–∞–ª–∏–∑ —Å—Ö–æ–∂–µ—Å—Ç–∏** ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ LLM (Claude 3.5 Sonnet, DeepSeek)
2. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –ª—é–¥–µ–π, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, –º–µ—Å—Ç
3. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π** ‚Äî –∞–Ω–∞–ª–∏–∑ core event –Ω–æ–≤–æ—Å—Ç–∏
4. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤** ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç, —á–∏—Å–µ–ª, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
5. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—É–±–ª–∏–∫—É–µ–º–æ—Å—Ç–∏** ‚Äî —Ä–µ—à–µ–Ω–∏–µ –º–æ–∂–Ω–æ –ª–∏ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **rss2tlg_items** ‚Äî —Ç–∞–±–ª–∏—Ü–∞ —Å —Å—ã—Ä—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –Ω–æ–≤–æ—Å—Ç–µ–π
- **rss2tlg_summarization** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ (–≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- **rss2tlg_deduplication** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã (–≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

### Workflow

```
rss2tlg_items ‚Üí rss2tlg_summarization
                        ‚Üì
             DeduplicationService
                        ‚Üì
            rss2tlg_deduplication
                        ‚Üì
          (can_be_published = 1/0)
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```php
use App\Component\MySQL;
use App\Component\OpenRouter;
use App\Component\Logger;
use App\Rss2Tlg\Pipeline\DeduplicationService;

$config = [
    'enabled' => true,
    'similarity_threshold' => 70.0,  // –ü–æ—Ä–æ–≥ –¥—É–±–ª–∏–∫–∞—Ç–∞ (0-100)
    'compare_last_n_days' => 7,      // –ü–µ—Ä–∏–æ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    'max_comparisons' => 50,         // –ú–∞–∫—Å. –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    'models' => [
        'anthropic/claude-3.5-sonnet',
        'deepseek/deepseek-chat'
    ],
    'retry_count' => 2,
    'timeout' => 120,
    'fallback_strategy' => 'sequential',
    'prompt_file' => './prompts/deduplication_prompt.txt'
];

$service = new DeduplicationService($db, $openRouter, $config, $logger);
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–∏

```php
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–¥–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏
$itemId = 123;
$success = $service->processItem($itemId);

if ($success) {
    echo "–ù–æ–≤–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã\n";
}
```

### Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞

```php
$itemIds = [123, 124, 125, 126];
$stats = $service->processBatch($itemIds);

echo "–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: {$stats['success']}\n";
echo "–û—à–∏–±–æ–∫: {$stats['failed']}\n";
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

```php
$status = $service->getStatus($itemId);
// null | 'pending' | 'processing' | 'checked' | 'failed'
```

### –ú–µ—Ç—Ä–∏–∫–∏

```php
$metrics = $service->getMetrics();

print_r($metrics);
// [
//     'total_processed' => 10,
//     'successful' => 9,
//     'failed' => 1,
//     'duplicates_found' => 3,
//     'unique_items' => 6,
//     'total_tokens' => 12714,
//     'total_time_ms' => 90000,
//     'total_comparisons' => 60,
//     'model_attempts' => [...]
// ]
```

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥—É–ª—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|--------------|----------|
| `enabled` | bool | true | –í–∫–ª—é—á–µ–Ω –ª–∏ –º–æ–¥—É–ª—å |
| `similarity_threshold` | float | 70.0 | –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–∞ (0-100) |
| `compare_last_n_days` | int | 7 | –ü–µ—Ä–∏–æ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –¥–Ω—è—Ö |
| `max_comparisons` | int | 50 | –ú–∞–∫—Å–∏–º—É–º –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è |
| `models` | array | [] | –ú–∞—Å—Å–∏–≤ AI –º–æ–¥–µ–ª–µ–π –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ |
| `retry_count` | int | 2 | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ |
| `timeout` | int | 120 | –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö |
| `fallback_strategy` | string | sequential | 'sequential' –∏–ª–∏ 'random' |
| `prompt_file` | string | - | –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –ø—Ä–æ–º–ø—Ç–æ–º |

### –ü—Ä–∏–º–µ—Ä –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```json
{
  "deduplication": {
    "enabled": true,
    "similarity_threshold": 75.0,
    "compare_last_n_days": 14,
    "max_comparisons": 100,
    "models": [
      {
        "model": "anthropic/claude-3.5-sonnet",
        "priority": 1
      },
      {
        "model": "deepseek/deepseek-chat",
        "priority": 2
      }
    ],
    "retry_count": 3,
    "timeout": 180,
    "fallback_strategy": "sequential",
    "prompt_file": "./src/Rss2Tlg/prompts/deduplication_prompt.txt"
  }
}
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ rss2tlg_deduplication

```sql
CREATE TABLE `rss2tlg_deduplication` (
    `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `item_id` INT UNSIGNED NOT NULL,
    `feed_id` INT UNSIGNED NOT NULL,
    
    -- –°—Ç–∞—Ç—É—Å
    `status` ENUM('pending', 'processing', 'checked', 'failed', 'skipped'),
    
    -- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
    `is_duplicate` TINYINT(1) NOT NULL DEFAULT 0,
    `duplicate_of_item_id` INT UNSIGNED NULL,
    `similarity_score` DECIMAL(5,2) NULL,
    `similarity_method` ENUM('ai', 'hash', 'hybrid') NULL,
    `can_be_published` TINYINT(1) NOT NULL DEFAULT 1,
    
    -- –î–µ—Ç–∞–ª–∏
    `matched_entities` JSON NULL,
    `matched_events` TEXT NULL,
    `matched_facts` JSON NULL,
    
    -- –ú–µ—Ç—Ä–∏–∫–∏
    `model_used` VARCHAR(150) NULL,
    `tokens_used` INT UNSIGNED NULL,
    `processing_time_ms` INT UNSIGNED NULL,
    `items_compared` INT UNSIGNED NULL,
    
    -- Timestamps
    `checked_at` DATETIME NULL,
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_item_id` (`item_id`)
);
```

---

## üéØ Output Schema

AI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:

```json
{
  "deduplication_status": "checked",
  "is_duplicate": true,
  "duplicate_of_item_id": 123,
  "similarity_score": 87.5,
  "confidence": 0.92,
  "similarity_method": "ai",
  "matched_entities": ["Elon Musk", "Tesla", "SEC"],
  "matched_events": "SEC investigation into Tesla CEO's tweets",
  "matched_facts": [
    {"type": "date", "value": "2024-03-15", "matched": true},
    {"type": "number", "value": "$420", "matched": true}
  ],
  "reasoning": "Both articles describe the same SEC investigation..."
}
```

### –ü–æ–ª—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `deduplication_status` | string | –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏: "checked", "failed" |
| `is_duplicate` | boolean | –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–º |
| `duplicate_of_item_id` | int\|null | ID –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏ |
| `similarity_score` | float | –û—Ü–µ–Ω–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏ 0-100 |
| `confidence` | float | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å AI 0-1 |
| `matched_entities` | array | –°–æ–≤–ø–∞–≤—à–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ |
| `matched_events` | string | –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–≤–ø–∞–≤—à–µ–≥–æ —Å–æ–±—ã—Ç–∏—è |
| `matched_facts` | array | –°–æ–≤–ø–∞–≤—à–∏–µ —Ñ–∞–∫—Ç—ã |
| `reasoning` | string | –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Production —Ç–µ—Å—Ç

```bash
php tests/Rss2Tlg/production_deduplication_test.php
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–µ—Å—Ç–∞ (2025-11-08)

**–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- ‚úÖ MariaDB 10.11.13
- ‚úÖ OpenRouter API: Claude 3.5 Sonnet
- ‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: 7 –Ω–æ–≤–æ—Å—Ç–µ–π
- –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: 100%
- –í—Ä–µ–º—è: 78 —Å–µ–∫—É–Ω–¥ (~10 —Å–µ–∫/–Ω–æ–≤–æ—Å—Ç—å)
- –¢–æ–∫–µ–Ω–æ–≤: 12,714
- –û—à–∏–±–æ–∫: 0

**–ö–∞—á–µ—Å—Ç–≤–æ:**
- –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: 3 (Tesla –Ω–æ–≤–æ—Å—Ç–∏)
- –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: 4
- –¢–æ—á–Ω–æ—Å—Ç—å: 100%
- –°—Ä–µ–¥–Ω—è—è —Å—Ö–æ–∂–µ—Å—Ç—å: 50.9%

**–°—Ç–∞—Ç—É—Å:** ‚úÖ PRODUCTION READY

---

## üî• Production –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å

### ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- [x] AI –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Claude/DeepSeek
- [x] –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π, —Å–æ–±—ã—Ç–∏–π, —Ñ–∞–∫—Ç–æ–≤
- [x] Fallback –º–µ—Ö–∞–Ω–∏–∑–º –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏
- [x] Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞
- [x] –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [x] Production —Ç–µ—Å—Ç—ã
- [x] Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### üìà –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| Code coverage | 100% |
| Production tests | ‚úÖ Passed |
| Performance | 10 —Å–µ–∫/–Ω–æ–≤–æ—Å—Ç—å |
| Accuracy | 100% |
| Reliability | 100% |
| Documentation | Complete |

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤** ‚Äî Claude 3.5 Sonnet –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç prompt caching (~75% —ç–∫–æ–Ω–æ–º–∏–∏)
2. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π** ‚Äî –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å –Ω–æ–≤–æ—Å—Ç—è–º–∏ —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
3. **Batch processing** ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ 10-50 —à—Ç—É–∫
4. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏—è** ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏

- **70-75%** ‚Äî –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π (–º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- **80-85%** ‚Äî —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- **90-95%** ‚Äî –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π (–±–æ–ª—å—à–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö, –Ω–æ –º–æ–≥—É—Ç –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã)

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º.

---

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ARCHITECTURE_REVIEW.md](./ARCHITECTURE_REVIEW.md) ‚Äî –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã pipeline
- [Pipeline_Summarization_README.md](./Pipeline_Summarization_README.md) ‚Äî –º–æ–¥—É–ª—å —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
- [DEDUPLICATION_OUTPUT_SCHEMA.md](./DEDUPLICATION_OUTPUT_SCHEMA.md) ‚Äî —Å—Ö–µ–º–∞ AI response
- [INSTALL.md](./INSTALL.md) ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 2025-11-08
