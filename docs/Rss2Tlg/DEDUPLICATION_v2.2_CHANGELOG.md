# üìù DeduplicationService v2.2 - Changelog

**–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** 2025-11-10  
**–í–µ—Ä—Å–∏—è:** 2.1 ‚Üí 2.2  

---

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. ‚ú® Category-based Similarity Scoring

**–ü—Ä–æ–±–ª–µ–º–∞:** Preliminary similarity –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–æ–≤–æ—Å—Ç–µ–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –ª–æ–∂–Ω—ã–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è–º –º–µ–∂–¥—É –∫—Ä–æ—Å—Å-–∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–º–∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—ã–π —Å–∫–æ—Ä–∏–Ω–≥ –≤ –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**

#### –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ similarity (v2.2):
```
similarity = entities * 30% + event * 25% + keywords * 20% + categories * 25%
```

#### –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞ (v2.1):
```
similarity = entities * 40% + event * 30% + keywords * 30%
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω–æ–π —Å—Ö–æ–∂–µ—Å—Ç–∏:**
- Primary == Primary: 100% (1.0)
- Primary == Secondary: 50% (0.5)
- Secondary overlap: 25% (0.25)
- –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: 0% (0.0)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚Üì15-20% –ª–æ–∂–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (cross-category false positives)
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
- –õ—É—á—à–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Å–æ–≤

---

### 2. üöÄ Importance Threshold –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–µ–¥—É–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–ª–∏—Å—å –í–°–ï –Ω–æ–≤–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è –Ω–∏–∑–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ (importance < 5), —á—Ç–æ —Ç—Ä–∞—Ç–∏–ª–æ —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ –Ω–µ–∑–Ω–∞—á–∏–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `min_importance_threshold` - –Ω–æ–≤–æ—Å—Ç–∏ —Å importance –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è.

**–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:**

#### –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (v2.2):
```php
if ($importance < min_importance_threshold) {
    // Skip deduplication
    // can_be_published = false
    // –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚Üì30-40% —Ç–æ–∫–µ–Ω–æ–≤ (–ø—Ä–∏ threshold = 5)
- ‚Üì25-35% –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ AI API

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```json
{
    "min_importance_threshold": 5,
    "similarity_weights": {
        "entities": 30.0,
        "event": 25.0,
        "keywords": 20.0,
        "categories": 25.0
    }
}
```

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- `min_importance_threshold`: 0-20
- `similarity_weights`: —Å—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100.0
- –ö–∞–∂–¥—ã–π –≤–µ—Å: 0-100

### –ö–æ–¥

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `DeduplicationService.php`:**

1. **validateModuleConfig()** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
2. **initializeMetrics()** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ—Ç—Ä–∏–∫–∞ `skipped_low_importance`
3. **processItem()** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ importance –ø–µ—Ä–µ–¥ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π
4. **getSummarizationData()** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `category_secondary`
5. **getSimilarItems()** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `category_secondary`
6. **calculatePreliminarySimilarity()** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–µ—Å–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ + category scoring
7. **calculateCategorySimilarity()** - –ù–û–í–´–ô –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω–æ–π —Å—Ö–æ–∂–µ—Å—Ç–∏

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- +120 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- +1 –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥
- +2 –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∫–æ–Ω—Ñ–∏–≥–∞
- +1 –Ω–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è:** `production/sql/migration_dedup_v2.2.sql`

```sql
ALTER TABLE rss2tlg_deduplication
ADD COLUMN skip_reason ENUM('low_importance', 'none') DEFAULT 'none';
```

**–ò–Ω–¥–µ–∫—Å—ã:**
- `idx_skip_reason`
- `idx_can_be_published`
- `idx_status_can_publish`

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (–ø—Ä–∏ threshold = 5)

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ v2.2 | –ü–æ—Å–ª–µ v2.2 | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|---------|------------|-----------|
| –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–æ–≤–æ—Å—Ç–µ–π | 100 | 60 | -40% |
| –¢–æ–∫–µ–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ | 300,000 | 180,000 | -40% |
| –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 100 –º–∏–Ω | 65 –º–∏–Ω | -35% |
| –°—Ç–æ–∏–º–æ—Å—Ç—å | $6.00 | $3.60 | -40% |

### –ö–∞—á–µ—Å—Ç–≤–æ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | v2.1 | v2.2 | –ò–∑–º–µ–Ω–µ–Ω–∏–µ |
|---------|------|------|-----------|
| False positives (cross-category) | 10% | 2-3% | ‚Üì70-80% |
| True positives | 90% | 95% | ‚Üë5% |
| –¢–æ—á–Ω–æ—Å—Ç—å | 90% | 97-98% | ‚Üë7-8% |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_deduplication_v2.2.php`

**–ü–æ–∫—Ä—ã—Ç–∏–µ:**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ Importance threshold logic
- ‚úÖ Category similarity algorithm
- ‚úÖ Weighted preliminary similarity
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:** –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã ‚úÖ

### Integration —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_deduplication_v2.2_integration.php`

**–°—Ü–µ–Ω–∞—Ä–∏–∏:**
- ‚úÖ Batch –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ importance
- ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ v2.1 vs v2.2
- ‚úÖ Cross-category filtering
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

---

## üìö –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `docs/Rss2Tlg/DEDUPLICATION_v2.2_REFACTORING_PLAN.md`
- `docs/Rss2Tlg/DEDUPLICATION_v2.2_CHANGELOG.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
- `production/configs/deduplication.commented.json`
- `production/sql/migration_dedup_v2.2.sql`

**–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `production/configs/deduplication.json`
- `src/Rss2Tlg/Pipeline/DeduplicationService.php`
- `docs/Rss2Tlg/Pipeline_Deduplication_README.md` (—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å)
- `docs/Rss2Tlg/DEDUPLICATION_v2.1_README.md` (—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å)

---

## ‚öôÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è —Å v2.1

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–î–æ–±–∞–≤–∏—Ç—å –≤ `production/configs/deduplication.json`:

```json
{
    "min_importance_threshold": 5,
    "similarity_weights": {
        "entities": 30.0,
        "event": 25.0,
        "keywords": 20.0,
        "categories": 25.0
    }
}
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
mysql -u rss2tlg_user -prss2tlg_password_2024 rss2tlg < production/sql/migration_dedup_v2.2.sql
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥

```bash
git pull origin main
composer install
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

```bash
php tests/test_deduplication_v2.2.php
```

---

## üö® Breaking Changes

### –ù–ï–¢ breaking changes! ‚úÖ

–í–µ—Ä—Å–∏—è v2.2 **–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–∞** —Å v2.1:
- –í—Å–µ –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –°—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- Fallback –Ω–∞ v2.1 –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è production

**–ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```json
{
    "min_importance_threshold": 3,
    "similarity_weights": {
        "entities": 35.0,
        "event": 25.0,
        "keywords": 15.0,
        "categories": 25.0
    }
}
```

**–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ threshold:**
- –ù–µ–¥–µ–ª—è 1: threshold = 3
- –ù–µ–¥–µ–ª—è 2: threshold = 4
- –ù–µ–¥–µ–ª—è 3: threshold = 5 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏:**
```php
$metrics = $service->getMetrics();
$skipRate = ($metrics['skipped_low_importance'] / $metrics['total_processed']) * 100;

if ($skipRate > 50) {
    // Threshold —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π - —Å–Ω–∏–∑—å—Ç–µ
}
```

### –î–ª—è –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

**–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç–∫–æ–Ω–æ–º–∏–∏:**
```json
{
    "min_importance_threshold": 7,
    "similarity_weights": {
        "entities": 25.0,
        "event": 25.0,
        "keywords": 20.0,
        "categories": 30.0
    }
}
```

---

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º ‚úÖ

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏:**
1. –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π threshold –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–∞–∂–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
2. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –≤–µ—Å–∞ —Ç—Ä–µ–±—É—é—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π use case

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤–µ—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫—É `skipped_low_importance`
- –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

---

## üìà Roadmap

### –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ v2.3

- [ ] Auto-tuning –≤–µ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] ML-–º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è importance threshold
- [ ] Dashboard –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ framework

---

## üë• –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä—ã

- **AI Assistant** - Design, Implementation, Testing, Documentation

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [Pipeline_Deduplication_README.md](./Pipeline_Deduplication_README.md)
- [DEDUPLICATION_v2.2_REFACTORING_PLAN.md](./DEDUPLICATION_v2.2_REFACTORING_PLAN.md)
- `production/configs/deduplication.commented.json`

**–í–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã:**
- GitHub Issues
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ `docs/Rss2Tlg/`

---

**–î–∞—Ç–∞:** 2025-11-10  
**–í–µ—Ä—Å–∏—è:** 2.2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Stable
