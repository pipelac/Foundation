# üìã –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê: DeduplicationService v3.0

**–î–∞—Ç–∞:** 2025-11-10  
**–í–µ—Ä—Å–∏—è:** 3.0 - Stepwise Multi-Language AI Deduplication  
**–ê–≤—Ç–æ—Ä:** AI Developer

---

## üéØ –¶–ï–õ–¨ –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–¥–≤—É—Ö—ç—Ç–∞–ø–Ω—É—é –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –Ω–æ–≤–æ—Å—Ç–µ–π** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫—Ä–æ—Å—Å—è–∑—ã—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ —ç–∫–æ–Ω–æ–º–∏–∏ AI –≤—ã–∑–æ–≤–æ–≤.

### –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (v2.0)

1. ‚ùå **–î–æ—Ä–æ–≥–æ–π AI –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤–æ—Å—Ç–µ–π** - –¥–∞–∂–µ –¥–ª—è —è–≤–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö
2. ‚ùå **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω—ã–µ –ø–æ–ª—è** - category_primary_en, keywords_en, entities_en, core_event_en
3. ‚ùå **–ù–µ—Ç –∫—Ä–æ—Å—Å—è–∑—ã—á–Ω–æ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏** - —Ä—É—Å—Å–∫–∞—è –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∞—è –≤–µ—Ä—Å–∏—è –æ–¥–Ω–æ–π –Ω–æ–≤–æ—Å—Ç–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—é—Ç—Å—è –∫–∞–∫ –¥—É–±–ª–∏–∫–∞—Ç—ã
4. ‚ùå **–ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π –æ—Ç–±–æ—Ä –ø–æ—Ö–æ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π** - —Ç–æ–ª—å–∫–æ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ò–õ–ò —è–∑—ã–∫—É
5. ‚ùå **–ù–µ—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –ø—É—Ç–∏** –¥–ª—è —è–≤–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ (v3.0)

1. ‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è 50-80% AI –≤—ã–∑–æ–≤–æ–≤** - –±—ã—Å—Ç—Ä—ã–π preliminary —Ñ–∏–ª—å—Ç—Ä
2. ‚úÖ **–ö—Ä–æ—Å—Å—è–∑—ã—á–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –≤–µ—Ä—Å–∏–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ **–î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑:**
   - –≠—Ç–∞–ø 1: –ë—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å —Å—Ö–æ–∂–µ—Å—Ç–∏ (1-2ms)
   - –≠—Ç–∞–ø 2: AI —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö)
4. ‚úÖ **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø–æ—Ä–æ–≥** - preliminary_similarity_threshold –≤ –∫–æ–Ω—Ñ–∏–≥–µ
5. ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - —Å–æ—Ö—Ä–∞–Ω—è–µ–º preliminary_score –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
6. ‚úÖ **–£–ª—É—á—à–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —ç–∫–æ–Ω–æ–º–∏—é AI –≤—ã–∑–æ–≤–æ–≤

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–û–ï –†–ï–®–ï–ù–ò–ï

### –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–ë–ï–ó –ª–∏—à–Ω–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π)

**‚úÖ –ß–¢–û –î–ï–õ–ê–ï–ú:**
- –í—Å–µ –≤ `DeduplicationService` v3.0
- –ù–æ–≤—ã–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã (Jaccard, Levenshtein, time diff)
- –ù–∏–∫–∞–∫–∏—Ö ML –º–æ–¥–µ–ª–µ–π - —á–∏—Å—Ç—ã–π PHP –∫–æ–¥

**‚ùå –ß–¢–û –ù–ï –î–ï–õ–ê–ï–ú:**
- ‚ùå –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å `SimilarityCalculator`
- ‚ùå Trait –¥–ª—è similarity —Ä–∞—Å—á–µ—Ç–æ–≤
- ‚ùå –°–ª–æ–∂–Ω—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- ‚ùå –í–Ω–µ—à–Ω–∏–µ ML –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

---

## üìä –î–í–£–•–≠–¢–ê–ü–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–ï–î–£–ü–õ–ò–ö–ê–¶–ò–ò

### –≠—Ç–∞–ø 1: Preliminary Similarity Check (Fast Path)

**–¶–µ–ª—å:** –ë—ã—Å—Ç—Ä–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —è–≤–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –ë–ï–ó AI –≤—ã–∑–æ–≤–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Ö–æ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏–∑ –ë–î (last N days, same category_en)
2. –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ—Ö–æ–∂–µ–π –Ω–æ–≤–æ—Å—Ç–∏ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å preliminary_similarity_score (0-100)
3. –ù–∞–π—Ç–∏ MAX(preliminary_similarity_score)
4. –ï—Å–ª–∏ MAX < preliminary_threshold (default 60):
   ‚Üí –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –£–ù–ò–ö–ê–õ–¨–ù–£–Æ (fast path)
   ‚Üí –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ë–ï–ó AI –≤—ã–∑–æ–≤–∞
5. –ï—Å–ª–∏ MAX >= preliminary_threshold:
   ‚Üí –ü–µ—Ä–µ–π—Ç–∏ –∫ –≠—Ç–∞–ø—É 2 (AI –∞–Ω–∞–ª–∏–∑)
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–æ–¥–µ–ª–∏ —Å—Ö–æ–∂–µ—Å—Ç–∏:**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|-----|----------|
| **Temporal proximity** | 10% | –ë–ª–∏–∑–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ |
| **Category match** | 20% | –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (EN –≤–µ—Ä—Å–∏–∏) |
| **Entity overlap** | 35% | Jaccard similarity –¥–ª—è entities_en |
| **Event similarity** | 20% | Text similarity –¥–ª—è core_event_en |
| **Keyword overlap** | 10% | Jaccard similarity –¥–ª—è keywords_en |
| **Numeric facts** | 5% | –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤ |

**–ò—Ç–æ–≥–æ:** preliminary_similarity_score = 0-100

### –≠—Ç–∞–ø 2: AI Semantic Analysis (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö)

**–¶–µ–ª—å:** –ì–ª—É–±–æ–∫–∏–π —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –Ω–æ–≤–æ—Å—Ç–µ–π —Å –≤—ã—Å–æ–∫–∏–º preliminary_score

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```
1. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ suspicious items (preliminary_score >= threshold)
2. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ç–æ–ø-N –ø–æ score, default max_ai_comparisons=10)
3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ AI –∞–Ω–∞–ª–∏–∑ —Å —Ç–µ–∫—É—â–∏–º –ø—Ä–æ–º–ø—Ç–æ–º
4. AI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (is_duplicate, similarity_score)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å AI –º–µ—Ç—Ä–∏–∫–∞–º–∏
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ AI –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä—ã
- ‚úÖ –ú–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø—Ä–æ–º–ø—Ç–µ (–º–µ–Ω—å—à–µ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è 50-80% AI –≤—ã–∑–æ–≤–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

---

## üî¢ –ê–õ–ì–û–†–ò–¢–ú–´ –†–ê–°–ß–ï–¢–ê –°–•–û–ñ–ï–°–¢–ò

### 1. Temporal Proximity (10 –±–∞–ª–ª–æ–≤ max)

```php
private function calculateTemporalSimilarity(string $date1, string $date2): float
```

**–õ–æ–≥–∏–∫–∞:**
- Same day (0 hours): **10.0 –±–∞–ª–ª–æ–≤**
- ¬±6 hours: **9.0 –±–∞–ª–ª–æ–≤**
- ¬±12 hours: **8.0 –±–∞–ª–ª–æ–≤**
- ¬±1 day: **7.0 –±–∞–ª–ª–æ–≤**
- ¬±2 days: **5.0 –±–∞–ª–ª–æ–≤**
- ¬±3 days: **3.0 –±–∞–ª–ª–æ–≤**
- ¬±7 days: **1.0 –±–∞–ª–ª**
- >7 days: **0.0 –±–∞–ª–ª–æ–≤**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ù–æ–≤–æ—Å—Ç–∏ –æ –æ–¥–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏ –æ–±—ã—á–Ω–æ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å–æ–≤/–¥–Ω–µ–π.

### 2. Category Match (20 –±–∞–ª–ª–æ–≤ max)

```php
private function calculateCategorySimilarity(array $item1, array $item2): float
```

**–õ–æ–≥–∏–∫–∞:**
- Primary category match (category_primary_en): **15.0 –±–∞–ª–ª–æ–≤**
- Secondary category overlap (category_secondary_en):
  - 1 —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ: **+2.5 –±–∞–ª–ª–∞**
  - 2 —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è: **+5.0 –±–∞–ª–ª–æ–≤**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –î—É–±–ª–∏–∫–∞—Ç—ã –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –≤ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (politics, war, sports –∏ —Ç.–¥.)

### 3. Entity Overlap (35 –±–∞–ª–ª–æ–≤ max) - –°–ê–ú–´–ô –í–ê–ñ–ù–´–ô!

```php
private function calculateEntityOverlap(array $entities1, array $entities2): float
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:** Jaccard Similarity
```
Jaccard = |A ‚à© B| / |A ‚à™ B|
Score = Jaccard √ó 35
```

**–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è entities:**
- Lowercase: "Putin" ‚Üí "putin"
- Trim –ø—Ä–æ–±–µ–ª–æ–≤
- –£–¥–∞–ª–µ–Ω–∏–µ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏ –≤ –∫–æ–Ω—Ü–µ

**–ü—Ä–∏–º–µ—Ä—ã:**
- entities1 = ["Putin", "Kremlin", "Russia"]
- entities2 = ["Putin", "Russia", "Ukraine"]
- Intersection = ["Putin", "Russia"] = 2
- Union = ["Putin", "Kremlin", "Russia", "Ukraine"] = 4
- Jaccard = 2/4 = 0.5
- Score = 0.5 √ó 35 = **17.5 –±–∞–ª–ª–æ–≤**

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –°—É—â–Ω–æ—Å—Ç–∏ - –∫–ª—é—á–µ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –ª—é–¥–∏, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –º–µ—Å—Ç–∞)

### 4. Event Similarity (20 –±–∞–ª–ª–æ–≤ max)

```php
private function calculateEventSimilarity(string $event1, string $event2): float
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:** Word Overlap + Levenshtein Distance

**–®–∞–≥ 1 - Word Overlap:**
```
1. –†–∞–∑–±–∏—Ç—å –Ω–∞ —Å–ª–æ–≤–∞: explode(' ', strtolower($event))
2. –£–¥–∞–ª–∏—Ç—å stop words (–∏, –≤, –Ω–∞, the, a, an, of –∏ —Ç.–¥.)
3. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å Jaccard similarity –¥–ª—è —Å–ª–æ–≤
```

**–®–∞–≥ 2 - Levenshtein Distance:**
```
1. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ (lowercase, trim)
2. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å levenshtein distance
3. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å: similarity = 1 - (distance / max_length)
```

**–§–∏–Ω–∞–ª—å–Ω—ã–π Score:**
```
Score = (word_overlap √ó 0.6 + levenshtein_similarity √ó 0.4) √ó 20
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è - —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

### 5. Keyword Overlap (10 –±–∞–ª–ª–æ–≤ max)

```php
private function calculateKeywordOverlap(array $keywords1, array $keywords2): float
```

**–ê–ª–≥–æ—Ä–∏—Ç–º:** Jaccard Similarity (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ entities)
```
Jaccard = |A ‚à© B| / |A ‚à™ B|
Score = Jaccard √ó 10
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–æ–ø–æ–ª–Ω—è—é—Ç entity –∏ event –∞–Ω–∞–ª–∏–∑

### 6. Numeric Facts Overlap (5 –±–∞–ª–ª–æ–≤ max)

```php
private function calculateNumericFactsOverlap(array $facts1, array $facts2): float
```

**–õ–æ–≥–∏–∫–∞:**
- –ò–∑–≤–ª–µ—á—å —á–∏—Å–ª–∞ –∏–∑ –æ–±–æ–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤ —Ñ–∞–∫—Ç–æ–≤
- –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å–æ–≤–ø–∞–¥–∞—é—â–∏–µ —á–∏—Å–ª–∞ (exact match)
- Score = min(matches, 5) –±–∞–ª–ª–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:**
- –î–∞—Ç—ã: "2024-03-15"
- –ß–∏—Å–ª–∞: "100", "$1000", "50%"
- –í—Ä–µ–º–µ–Ω–∞: "18:30"

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:** –ß–∏—Å–ª–æ–≤—ã–µ —Ñ–∞–∫—Ç—ã - —Å–∏–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

### –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç

```php
private function calculatePreliminarySimilarity(
    array $newItem, 
    array $existingItem
): float {
    $score = 0.0;
    
    $score += $this->calculateTemporalSimilarity($newItem['pub_date'], $existingItem['pub_date']);
    $score += $this->calculateCategorySimilarity($newItem, $existingItem);
    $score += $this->calculateEntityOverlap($newItem['entities_en'], $existingItem['entities_en']);
    $score += $this->calculateEventSimilarity($newItem['core_event_en'], $existingItem['core_event_en']);
    $score += $this->calculateKeywordOverlap($newItem['keywords_en'], $existingItem['keywords_en']);
    $score += $this->calculateNumericFactsOverlap($newItem['numeric_facts'], $existingItem['numeric_facts']);
    
    return min(100.0, max(0.0, $score));
}
```

---

## üóÑÔ∏è –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –ë–î

### –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ rss2tlg_deduplication

```sql
ALTER TABLE `rss2tlg_deduplication`
    ADD COLUMN `preliminary_similarity_score` DECIMAL(5,2) DEFAULT NULL 
        COMMENT '–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏ (0.00-100.00)' 
        AFTER `similarity_score`,
    ADD COLUMN `preliminary_method` VARCHAR(50) DEFAULT 'hybrid_v1' 
        COMMENT '–ú–µ—Ç–æ–¥ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–∏' 
        AFTER `similarity_method`,
    ADD COLUMN `ai_analysis_triggered` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '–ë—ã–ª –ª–∏ –≤—ã–∑–≤–∞–Ω AI –∞–Ω–∞–ª–∏–∑ (0/1)' 
        AFTER `preliminary_method`;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
CREATE INDEX idx_preliminary_score ON rss2tlg_deduplication(preliminary_similarity_score);
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ getSummarizationData()

**–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä–∫—É –±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π:**

```sql
SELECT 
    s.item_id,
    s.feed_id,
    s.status as summarization_status,
    s.headline,
    s.summary,
    s.article_language,
    s.category_primary,
    s.category_primary_en,          -- NEW!
    s.category_secondary,
    s.category_secondary_en,        -- NEW!
    s.keywords,
    s.keywords_en,                  -- NEW!
    s.importance_rating,
    s.dedup_canonical_entities,
    s.dedup_canonical_entities_en,  -- NEW!
    s.dedup_core_event,
    s.dedup_core_event_en,          -- NEW!
    s.dedup_numeric_facts,
    i.title as original_title,
    i.link,
    i.pub_date
FROM rss2tlg_summarization s
INNER JOIN rss2tlg_items i ON s.item_id = i.id
WHERE s.item_id = :item_id
LIMIT 1
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ getSimilarItems()

**–£–ª—É—á—à–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞:**

```sql
SELECT 
    s.item_id,
    s.headline,
    s.summary,
    s.article_language,
    s.category_primary,
    s.category_primary_en,          -- NEW!
    s.category_secondary,
    s.category_secondary_en,        -- NEW!
    s.keywords,
    s.keywords_en,                  -- NEW!
    s.dedup_canonical_entities,
    s.dedup_canonical_entities_en,  -- NEW!
    s.dedup_core_event,
    s.dedup_core_event_en,          -- NEW!
    s.dedup_numeric_facts,
    i.pub_date
FROM rss2tlg_summarization s
INNER JOIN rss2tlg_items i ON s.item_id = i.id
WHERE s.item_id != :item_id
  AND s.status = 'success'
  AND i.pub_date >= DATE_SUB(:ref_date, INTERVAL :days_back DAY)
  AND i.pub_date <= DATE_ADD(:ref_date, INTERVAL 1 DAY)
  AND s.category_primary_en = :category_en          -- –ò—Å–ø–æ–ª—å–∑—É–µ–º EN –≤–µ—Ä—Å–∏—é!
ORDER BY i.pub_date DESC
LIMIT :max_limit
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º `category_primary_en` –¥–ª—è –∫—Ä–æ—Å—Å—è–∑—ã—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω: –æ—Ç (ref_date - N days) –¥–æ (ref_date + 1 day)
- ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è preliminary –∞–Ω–∞–ª–∏–∑–∞

---

## üìù –ù–û–í–´–ï/–û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ú–ï–¢–û–î–´

### 1. processItem() - –û–ë–ù–û–í–ò–¢–¨

**–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

```php
public function processItem(int $itemId): bool
{
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ...
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ö–æ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
    $similarItems = $this->getSimilarItems($itemId, $itemData);
    
    if (empty($similarItems)) {
        // Fast path: –Ω–µ—Ç –ø–æ—Ö–æ–∂–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π
        $this->saveDedupResult($itemId, (int)$itemData['feed_id'], [
            'is_duplicate' => false,
            'can_be_published' => true,
            'similarity_score' => 0.0,
            'preliminary_similarity_score' => 0.0,
            'ai_analysis_triggered' => false,
        ]);
        
        $this->incrementMetric('fast_path_unique');
        return true;
    }
    
    // –≠–¢–ê–ü 1: Preliminary Similarity Analysis
    $preliminaryResults = $this->analyzePreliminarySimilarity($itemData, $similarItems);
    $maxPreliminaryScore = $preliminaryResults['max_score'];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥
    if ($maxPreliminaryScore < $this->config['preliminary_similarity_threshold']) {
        // Fast path: —è–≤–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è
        $this->saveDedupResult($itemId, (int)$itemData['feed_id'], [
            'is_duplicate' => false,
            'can_be_published' => true,
            'similarity_score' => $maxPreliminaryScore,
            'preliminary_similarity_score' => $maxPreliminaryScore,
            'ai_analysis_triggered' => false,
        ]);
        
        $this->incrementMetric('fast_path_unique');
        $this->incrementMetric('ai_calls_saved');
        return true;
    }
    
    // –≠–¢–ê–ü 2: AI Semantic Analysis (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö)
    $suspiciousItems = $this->filterSuspiciousItems($similarItems, $preliminaryResults);
    $dedupResult = $this->analyzeDeduplicationWithAI($itemId, $itemData, $suspiciousItems);
    
    // –î–æ–±–∞–≤–ª—è–µ–º preliminary –º–µ—Ç—Ä–∏–∫–∏
    $dedupResult['preliminary_similarity_score'] = $maxPreliminaryScore;
    $dedupResult['ai_analysis_triggered'] = true;
    
    $this->saveDedupResult($itemId, (int)$itemData['feed_id'], $dedupResult);
    
    // ... –º–µ—Ç—Ä–∏–∫–∏ ...
}
```

### 2. analyzePreliminarySimilarity() - –ù–û–í–´–ô

```php
/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å—Ö–æ–∂–µ—Å—Ç—å —Å –ø–æ—Ö–æ–∂–∏–º–∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏
 *
 * @param array<string, mixed> $newItem –ù–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å
 * @param array<array<string, mixed>> $similarItems –ü–æ—Ö–æ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏
 * @return array{max_score: float, scores: array<int, float>}
 */
private function analyzePreliminarySimilarity(array $newItem, array $similarItems): array
{
    $scores = [];
    $maxScore = 0.0;
    
    foreach ($similarItems as $existingItem) {
        $score = $this->calculatePreliminarySimilarity($newItem, $existingItem);
        $scores[(int)$existingItem['item_id']] = $score;
        
        if ($score > $maxScore) {
            $maxScore = $score;
        }
    }
    
    $this->logDebug('Preliminary similarity analysis', [
        'max_score' => $maxScore,
        'items_analyzed' => count($similarItems),
    ]);
    
    return [
        'max_score' => $maxScore,
        'scores' => $scores,
    ];
}
```

### 3. calculatePreliminarySimilarity() - –ù–û–í–´–ô

```php
/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é —Å—Ö–æ–∂–µ—Å—Ç—å –º–µ–∂–¥—É –¥–≤—É–º—è –Ω–æ–≤–æ—Å—Ç—è–º–∏
 *
 * @param array<string, mixed> $newItem –ù–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å
 * @param array<string, mixed> $existingItem –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –Ω–æ–≤–æ—Å—Ç—å
 * @return float –û—Ü–µ–Ω–∫–∞ —Å—Ö–æ–∂–µ—Å—Ç–∏ (0.0-100.0)
 */
private function calculatePreliminarySimilarity(array $newItem, array $existingItem): float
{
    $score = 0.0;
    
    // 1. Temporal proximity (10%)
    $score += $this->calculateTemporalSimilarity(
        $newItem['pub_date'], 
        $existingItem['pub_date']
    );
    
    // 2. Category match (20%)
    $score += $this->calculateCategorySimilarity($newItem, $existingItem);
    
    // 3. Entity overlap (35%) - –°–ê–ú–´–ô –í–ê–ñ–ù–´–ô!
    $entitiesNew = $this->decodeJsonField($newItem['dedup_canonical_entities_en']);
    $entitiesExisting = $this->decodeJsonField($existingItem['dedup_canonical_entities_en']);
    $score += $this->calculateEntityOverlap($entitiesNew, $entitiesExisting);
    
    // 4. Event similarity (20%)
    $score += $this->calculateEventSimilarity(
        $newItem['dedup_core_event_en'] ?? '',
        $existingItem['dedup_core_event_en'] ?? ''
    );
    
    // 5. Keyword overlap (10%)
    $keywordsNew = $this->decodeJsonField($newItem['keywords_en']);
    $keywordsExisting = $this->decodeJsonField($existingItem['keywords_en']);
    $score += $this->calculateKeywordOverlap($keywordsNew, $keywordsExisting);
    
    // 6. Numeric facts (5%)
    $factsNew = $this->decodeJsonField($newItem['dedup_numeric_facts']);
    $factsExisting = $this->decodeJsonField($existingItem['dedup_numeric_facts']);
    $score += $this->calculateNumericFactsOverlap($factsNew, $factsExisting);
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ –¥–∏–∞–ø–∞–∑–æ–Ω—É 0-100
    return min(100.0, max(0.0, $score));
}
```

### 4. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã —Ä–∞—Å—á–µ—Ç–∞

```php
/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
 *
 * @param string $date1
 * @param string $date2
 * @return float –ë–∞–ª–ª—ã (0.0-10.0)
 */
private function calculateTemporalSimilarity(string $date1, string $date2): float
{
    $timestamp1 = strtotime($date1);
    $timestamp2 = strtotime($date2);
    
    if ($timestamp1 === false || $timestamp2 === false) {
        return 0.0;
    }
    
    $hoursDiff = abs($timestamp1 - $timestamp2) / 3600;
    
    if ($hoursDiff <= 6) return 10.0;
    if ($hoursDiff <= 12) return 9.0;
    if ($hoursDiff <= 24) return 8.0;
    if ($hoursDiff <= 48) return 5.0;
    if ($hoursDiff <= 72) return 3.0;
    if ($hoursDiff <= 168) return 1.0;
    
    return 0.0;
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
 *
 * @param array<string, mixed> $item1
 * @param array<string, mixed> $item2
 * @return float –ë–∞–ª–ª—ã (0.0-20.0)
 */
private function calculateCategorySimilarity(array $item1, array $item2): float
{
    $score = 0.0;
    
    // Primary category match (15 –±–∞–ª–ª–æ–≤)
    if (($item1['category_primary_en'] ?? '') === ($item2['category_primary_en'] ?? '')) {
        $score += 15.0;
    }
    
    // Secondary categories overlap (5 –±–∞–ª–ª–æ–≤ max)
    $secondary1 = $this->decodeJsonField($item1['category_secondary_en']);
    $secondary2 = $this->decodeJsonField($item2['category_secondary_en']);
    
    $overlap = count(array_intersect($secondary1, $secondary2));
    $score += min(5.0, $overlap * 2.5);
    
    return $score;
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç Jaccard similarity –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤
 *
 * @param array<string> $array1
 * @param array<string> $array2
 * @return float Jaccard coefficient (0.0-1.0)
 */
private function calculateJaccardSimilarity(array $array1, array $array2): float
{
    if (empty($array1) && empty($array2)) {
        return 0.0;
    }
    
    // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: lowercase, trim
    $array1 = array_map(fn($s) => strtolower(trim($s)), $array1);
    $array2 = array_map(fn($s) => strtolower(trim($s)), $array2);
    
    $intersection = array_intersect($array1, $array2);
    $union = array_unique(array_merge($array1, $array2));
    
    if (count($union) === 0) {
        return 0.0;
    }
    
    return count($intersection) / count($union);
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç overlap —Å—É—â–Ω–æ—Å—Ç–µ–π
 *
 * @param array<string> $entities1
 * @param array<string> $entities2
 * @return float –ë–∞–ª–ª—ã (0.0-35.0)
 */
private function calculateEntityOverlap(array $entities1, array $entities2): float
{
    $jaccard = $this->calculateJaccardSimilarity($entities1, $entities2);
    return $jaccard * 35.0;
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ö–æ–∂–µ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏–π —Å–æ–±—ã—Ç–∏–π
 *
 * @param string $event1
 * @param string $event2
 * @return float –ë–∞–ª–ª—ã (0.0-20.0)
 */
private function calculateEventSimilarity(string $event1, string $event2): float
{
    if (empty($event1) || empty($event2)) {
        return 0.0;
    }
    
    // Word overlap (60%)
    $words1 = $this->extractSignificantWords($event1);
    $words2 = $this->extractSignificantWords($event2);
    $wordOverlap = $this->calculateJaccardSimilarity($words1, $words2);
    
    // Levenshtein similarity (40%)
    $levenshteinSim = $this->calculateLevenshteinSimilarity($event1, $event2);
    
    $similarity = ($wordOverlap * 0.6) + ($levenshteinSim * 0.4);
    
    return $similarity * 20.0;
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∑–Ω–∞—á–∏–º—ã–µ —Å–ª–æ–≤–∞ (–±–µ–∑ stop words)
 *
 * @param string $text
 * @return array<string>
 */
private function extractSignificantWords(string $text): array
{
    $stopWords = [
        'a', 'an', 'and', 'are', 'as', 'at', 'be', 'by', 'for', 'from',
        'has', 'he', 'in', 'is', 'it', 'its', 'of', 'on', 'that', 'the',
        'to', 'was', 'will', 'with',
        // –†—É—Å—Å–∫–∏–µ stop words
        '–≤', '–∏', '–Ω–∞', '—Å', '–ø–æ', '–∫', '–æ', '–æ—Ç', '–∏–∑', '–∑–∞', '—É', '–¥–ª—è'
    ];
    
    $words = preg_split('/\s+/', strtolower($text));
    $words = array_map('trim', $words);
    $words = array_filter($words, fn($w) => !empty($w) && !in_array($w, $stopWords));
    
    return array_values($words);
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç Levenshtein similarity
 *
 * @param string $str1
 * @param string $str2
 * @return float Similarity (0.0-1.0)
 */
private function calculateLevenshteinSimilarity(string $str1, string $str2): float
{
    $str1 = strtolower(trim($str1));
    $str2 = strtolower(trim($str2));
    
    $maxLength = max(mb_strlen($str1), mb_strlen($str2));
    
    if ($maxLength === 0) {
        return 0.0;
    }
    
    $distance = levenshtein($str1, $str2);
    
    return 1.0 - ($distance / $maxLength);
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç overlap –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
 *
 * @param array<string> $keywords1
 * @param array<string> $keywords2
 * @return float –ë–∞–ª–ª—ã (0.0-10.0)
 */
private function calculateKeywordOverlap(array $keywords1, array $keywords2): float
{
    $jaccard = $this->calculateJaccardSimilarity($keywords1, $keywords2);
    return $jaccard * 10.0;
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç overlap —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–∞–∫—Ç–æ–≤
 *
 * @param array<string> $facts1
 * @param array<string> $facts2
 * @return float –ë–∞–ª–ª—ã (0.0-5.0)
 */
private function calculateNumericFactsOverlap(array $facts1, array $facts2): float
{
    if (empty($facts1) || empty($facts2)) {
        return 0.0;
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–∞ –∏–∑ –º–∞—Å—Å–∏–≤–æ–≤
    $numbers1 = $this->extractNumbers($facts1);
    $numbers2 = $this->extractNumbers($facts2);
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
    $matches = count(array_intersect($numbers1, $numbers2));
    
    return min(5.0, (float)$matches);
}

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —á–∏—Å–ª–∞ –∏–∑ –º–∞—Å—Å–∏–≤–∞ —Ñ–∞–∫—Ç–æ–≤
 *
 * @param array<string> $facts
 * @return array<string>
 */
private function extractNumbers(array $facts): array
{
    $numbers = [];
    
    foreach ($facts as $fact) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ —á–∏—Å–ª–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏
        if (preg_match_all('/\d+(?:[.,]\d+)?/', $fact, $matches)) {
            $numbers = array_merge($numbers, $matches[0]);
        }
    }
    
    return array_unique($numbers);
}

/**
 * –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç JSON –ø–æ–ª–µ
 *
 * @param string|null $jsonString
 * @return array<string>
 */
private function decodeJsonField(?string $jsonString): array
{
    if (empty($jsonString)) {
        return [];
    }
    
    $decoded = json_decode($jsonString, true);
    
    return is_array($decoded) ? $decoded : [];
}
```

### 5. filterSuspiciousItems() - –ù–û–í–´–ô

```php
/**
 * –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞
 *
 * @param array<array<string, mixed>> $similarItems
 * @param array{max_score: float, scores: array<int, float>} $preliminaryResults
 * @return array<array<string, mixed>>
 */
private function filterSuspiciousItems(array $similarItems, array $preliminaryResults): array
{
    $threshold = $this->config['preliminary_similarity_threshold'];
    $maxAiComparisons = $this->config['max_ai_comparisons'] ?? 10;
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ suspicious
    $suspicious = [];
    foreach ($similarItems as $item) {
        $itemId = (int)$item['item_id'];
        $score = $preliminaryResults['scores'][$itemId] ?? 0.0;
        
        if ($score >= $threshold) {
            $suspicious[] = [
                'item' => $item,
                'preliminary_score' => $score,
            ];
        }
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é score
    usort($suspicious, fn($a, $b) => $b['preliminary_score'] <=> $a['preliminary_score']);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    $suspicious = array_slice($suspicious, 0, $maxAiComparisons);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ item
    return array_map(fn($s) => $s['item'], $suspicious);
}
```

### 6. analyzeDeduplicationWithAI() - –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–¢–¨ analyzeDeduplication()

```php
/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ AI (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö)
 *
 * @param int $itemId
 * @param array<string, mixed> $itemData
 * @param array<array<string, mixed>> $suspiciousItems –¢–æ–ª—å–∫–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏
 * @return array<string, mixed>|null
 */
private function analyzeDeduplicationWithAI(
    int $itemId, 
    array $itemData, 
    array $suspiciousItems
): ?array {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ analyzeDeduplication ...
    // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π - —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
}
```

---

## ‚öôÔ∏è –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò

### production/configs/deduplication.json

```json
{
    "enabled": true,
    "models": [
        "google/gemma-3-27b-it",
        "deepseek/deepseek-chat",
        "deepseek/deepseek-v3.2-exp"
    ],
    "prompt_file": "production/prompts/deduplication_prompt_v2.txt",
    "fallback_strategy": "sequential",
    "retry_count": 2,
    "timeout": 120,
    
    "compare_last_n_days": 7,
    "max_comparisons": 50,
    "max_ai_comparisons": 10,
    
    "preliminary_similarity_threshold": 60,
    "similarity_threshold": 70
}
```

**–ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | Default | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|---------|----------|
| `preliminary_similarity_threshold` | int | 60 | –ü–æ—Ä–æ–≥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞ (0-100) |
| `max_ai_comparisons` | int | 10 | –ú–∞–∫—Å. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤–æ—Å—Ç–µ–π –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞ |

---

## üìä –ù–û–í–´–ï –ú–ï–¢–†–ò–ö–ò

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ initializeMetrics()

```php
protected function initializeMetrics(): array
{
    return [
        'total_processed' => 0,
        'successful' => 0,
        'failed' => 0,
        'skipped' => 0,
        'duplicates_found' => 0,
        'unique_items' => 0,
        'total_tokens' => 0,
        'total_time_ms' => 0,
        'total_comparisons' => 0,
        'model_attempts' => [],
        
        // NEW METRICS v3.0
        'preliminary_checks' => 0,           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ preliminary –ø—Ä–æ–≤–µ—Ä–æ–∫
        'ai_calls_saved' => 0,               // –°–∫–æ–ª—å–∫–æ AI –≤—ã–∑–æ–≤–æ–≤ –∏–∑–±–µ–∂–∞–ª–∏
        'fast_path_unique' => 0,             // –ü–æ–º–µ—á–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –±–µ–∑ AI
        'ai_triggered' => 0,                 // –í—ã–∑–æ–≤–æ–≤ AI –ø–æ—Å–ª–µ preliminary
        'avg_preliminary_score' => 0.0,      // –°—Ä–µ–¥–Ω–∏–π preliminary score
        'similarity_distribution' => [],     // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ preliminary scores
    ];
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ saveDedupResult()

**–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:**

```php
private function saveDedupResult(int $itemId, int $feedId, array $result): void
{
    $query = "
        INSERT INTO rss2tlg_deduplication (
            item_id,
            feed_id,
            status,
            is_duplicate,
            duplicate_of_item_id,
            similarity_score,
            preliminary_similarity_score,      -- NEW!
            preliminary_method,                 -- NEW!
            ai_analysis_triggered,              -- NEW!
            similarity_method,
            can_be_published,
            matched_entities,
            matched_events,
            matched_facts,
            model_used,
            tokens_used,
            processing_time_ms,
            items_compared,
            checked_at,
            created_at,
            updated_at
        ) VALUES (
            :item_id,
            :feed_id,
            'checked',
            :is_duplicate,
            :duplicate_of_item_id,
            :similarity_score,
            :preliminary_similarity_score,     -- NEW!
            :preliminary_method,                -- NEW!
            :ai_analysis_triggered,             -- NEW!
            :similarity_method,
            :can_be_published,
            :matched_entities,
            :matched_events,
            :matched_facts,
            :model_used,
            :tokens_used,
            :processing_time_ms,
            :items_compared,
            NOW(),
            NOW(),
            NOW()
        )
        ON DUPLICATE KEY UPDATE
            status = VALUES(status),
            is_duplicate = VALUES(is_duplicate),
            duplicate_of_item_id = VALUES(duplicate_of_item_id),
            similarity_score = VALUES(similarity_score),
            preliminary_similarity_score = VALUES(preliminary_similarity_score),
            preliminary_method = VALUES(preliminary_method),
            ai_analysis_triggered = VALUES(ai_analysis_triggered),
            similarity_method = VALUES(similarity_method),
            can_be_published = VALUES(can_be_published),
            matched_entities = VALUES(matched_entities),
            matched_events = VALUES(matched_events),
            matched_facts = VALUES(matched_facts),
            model_used = VALUES(model_used),
            tokens_used = VALUES(tokens_used),
            processing_time_ms = VALUES(processing_time_ms),
            items_compared = VALUES(items_compared),
            checked_at = VALUES(checked_at),
            updated_at = NOW()
    ";
    
    $params = [
        'item_id' => $itemId,
        'feed_id' => $feedId,
        'is_duplicate' => $result['is_duplicate'] ? 1 : 0,
        'duplicate_of_item_id' => $result['duplicate_of_item_id'] ?? null,
        'similarity_score' => $result['similarity_score'] ?? 0.0,
        'preliminary_similarity_score' => $result['preliminary_similarity_score'] ?? null,
        'preliminary_method' => $result['preliminary_method'] ?? 'hybrid_v1',
        'ai_analysis_triggered' => $result['ai_analysis_triggered'] ?? 0,
        'similarity_method' => $result['similarity_method'] ?? 'hybrid',
        'can_be_published' => $result['can_be_published'] ? 1 : 0,
        'matched_entities' => $result['matched_entities'] ?? '[]',
        'matched_events' => $result['matched_events'] ?? null,
        'matched_facts' => $result['matched_facts'] ?? '[]',
        'model_used' => $result['model_used'] ?? null,
        'tokens_used' => $result['tokens_used'] ?? null,
        'processing_time_ms' => $result['processing_time_ms'] ?? 0,
        'items_compared' => $result['items_compared'] ?? 0,
    ];
    
    $this->db->execute($query, $params);
}
```

---

## üóÇÔ∏è –§–ê–ô–õ–û–í–ê–Ø –°–¢–†–£–ö–¢–£–†–ê

```
src/Rss2Tlg/Pipeline/
‚îú‚îÄ‚îÄ DeduplicationService.php         ‚Üê –û–ë–ù–û–í–ò–¢–¨ (v3.0)
‚îú‚îÄ‚îÄ AbstractPipelineModule.php       ‚Üê –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
‚îî‚îÄ‚îÄ AIAnalysisTrait.php              ‚Üê –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô

production/
‚îú‚îÄ‚îÄ configs/
‚îÇ   ‚îî‚îÄ‚îÄ deduplication.json           ‚Üê –û–ë–ù–û–í–ò–¢–¨ (–Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îî‚îÄ‚îÄ deduplication_prompt_v2.txt  ‚Üê –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–æ–±–∞–≤–∏—Ç—å preliminary_score)
‚îî‚îÄ‚îÄ sql/
    ‚îî‚îÄ‚îÄ migration_dedup_v3.sql       ‚Üê –°–û–ó–î–ê–¢–¨ (–Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ –ë–î)

docs/Rss2Tlg/
‚îú‚îÄ‚îÄ DEDUPLICATION_REFACTORING_PLAN_V3.md  ‚Üê –≠–¢–û–¢ –î–û–ö–£–ú–ï–ù–¢
‚îî‚îÄ‚îÄ Pipeline_Deduplication_README.md      ‚Üê –û–ë–ù–û–í–ò–¢–¨ (v3.0 API)
```

---

## üéØ –≠–¢–ê–ü–´ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î (5 –º–∏–Ω)
- ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `migration_dedup_v3.sql`
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è: preliminary_similarity_score, preliminary_method, ai_analysis_triggered
- ‚úÖ –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã

### –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (10 –º–∏–Ω)
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `getSummarizationData()` - –¥–æ–±–∞–≤–∏—Ç—å –±–∏–ª–∏–Ω–≥–≤–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `getSimilarItems()` - —É–ª—É—á—à–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞
- ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã

### –≠—Ç–∞–ø 3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Preliminary Similarity (40 –º–∏–Ω)
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `calculatePreliminarySimilarity()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `calculateTemporalSimilarity()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `calculateCategorySimilarity()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `calculateEntityOverlap()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `calculateEventSimilarity()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `calculateKeywordOverlap()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `calculateNumericFactsOverlap()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
  - `calculateJaccardSimilarity()`
  - `calculateLevenshteinSimilarity()`
  - `extractSignificantWords()`
  - `extractNumbers()`
  - `decodeJsonField()`

### –≠—Ç–∞–ø 4: –î–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –ª–æ–≥–∏–∫–∞ (20 –º–∏–Ω)
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `analyzePreliminarySimilarity()`
- ‚úÖ –°–æ–∑–¥–∞—Ç—å `filterSuspiciousItems()`
- ‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `analyzeDeduplication()` ‚Üí `analyzeDeduplicationWithAI()`
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `processItem()` - –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –ª–æ–≥–∏–∫–∞

### –≠—Ç–∞–ø 5: –ú–µ—Ç—Ä–∏–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (10 –º–∏–Ω)
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `initializeMetrics()`
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `saveDedupResult()`
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ preliminary scores

### –≠—Ç–∞–ø 6: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (10 –º–∏–Ω)
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `production/configs/deduplication.json`
- ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `docs/Rss2Tlg/Pipeline_Deduplication_README.md`
- ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –≠—Ç–∞–ø 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ù–ï –î–ï–õ–ê–¢–¨ –°–ï–ô–ß–ê–°!)
- ‚è∏Ô∏è –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç (–ü–û–ó–ñ–ï)
- ‚è∏Ô∏è –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ü–û–ó–ñ–ï)

---

## üìà –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞ | v2.0 (—Ç–µ–∫—É—â–∞—è) | v3.0 (–ø–ª–∞–Ω–∏—Ä—É–µ–º–∞—è) | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----------------|---------------------|-----------|
| **AI –≤—ã–∑–æ–≤–æ–≤** | 100% | 20-50% | ‚Üì 50-80% |
| **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏** | ~60 —Å–µ–∫/–Ω–æ–≤–æ—Å—Ç—å | ~5-60 —Å–µ–∫ | ‚Üì ~50% avg |
| **–°—Ç–æ–∏–º–æ—Å—Ç—å** | $0.05/–Ω–æ–≤–æ—Å—Ç—å | $0.01-0.05 | ‚Üì 50-80% |
| **–¢–æ–∫–µ–Ω–æ–≤** | ~7,000/–Ω–æ–≤–æ—Å—Ç—å | ~1,500-7,000 | ‚Üì 50-80% |

### –¢–æ—á–Ω–æ—Å—Ç—å

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | v2.0 | v3.0 | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------------|------|------|-------------|
| **False Positives** | Low | Low | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (AI –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) |
| **False Negatives** | Low | Medium-Low | –í–æ–∑–º–æ–∂–Ω—ã –∏–∑-–∑–∞ –ø–æ—Ä–æ–≥–∞ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ) |
| **–ö—Ä–æ—Å—Å-—è–∑—ã–∫** | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ | –ê–Ω–≥–ª–∏–π—Å–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ! |

### –≠–∫–æ–Ω–æ–º–∏—è

- **50-80% –Ω–æ–≤–æ—Å—Ç–µ–π** –±—É–¥—É—Ç –ø–æ–º–µ—á–µ–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ë–ï–ó AI –≤—ã–∑–æ–≤–∞
- **–≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤:** ~5,000-6,000 —Ç–æ–∫–µ–Ω–æ–≤/–Ω–æ–≤–æ—Å—Ç—å (–¥–ª—è fast path)
- **–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏:** ~55-58 —Å–µ–∫/–Ω–æ–≤–æ—Å—Ç—å (–¥–ª—è fast path)
- **–≠–∫–æ–Ω–æ–º–∏—è –¥–µ–Ω–µ–≥:** ~$0.04/–Ω–æ–≤–æ—Å—Ç—å (–¥–ª—è fast path)

**–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è 1,000 –Ω–æ–≤–æ—Å—Ç–µ–π/–¥–µ–Ω—å:**
- v2.0: 1,000 √ó $0.05 = **$50/–¥–µ–Ω—å**
- v3.0: (300 √ó $0.05) + (700 √ó $0.001) = **$15.70/–¥–µ–Ω—å**
- **–≠–∫–æ–Ω–æ–º–∏—è:** $34.30/–¥–µ–Ω—å = **$1,029/–º–µ—Å—è—Ü** = **$12,348/–≥–æ–¥** üéâ

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞

**Preliminary Similarity Threshold** - –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä!

- **–°–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π (30-40):** –ü–æ—á—Ç–∏ –≤—Å–µ –ø–æ–π–¥—É—Ç –Ω–∞ AI ‚Üí –Ω–µ—Ç —ç–∫–æ–Ω–æ–º–∏–∏
- **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π (60-70):** –ë–∞–ª–∞–Ω—Å —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ —ç–∫–æ–Ω–æ–º–∏–∏
- **–°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π (80-90):** –ú–Ω–æ–≥–æ false negatives (–ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å 60, –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å False Negatives, –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å.

### 2. –ö—Ä–æ—Å—Å—è–∑—ã—á–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞ AI –ø–µ—Ä–µ–≤–æ–¥–∞:**
- –ï—Å–ª–∏ AI –ø–ª–æ—Ö–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç entities/events –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Üí preliminary —Ñ–∏–ª—å—Ç—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
- **–†–µ—à–µ–Ω–∏–µ:** –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –≤ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏

### 3. Stop words

**–°–ø–∏—Å–æ–∫ stop words** –≤ `extractSignificantWords()` –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–ª—è—Ç—å –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–∏—Å–ø–∞–Ω—Å–∫–∏–π, –Ω–µ–º–µ—Ü–∫–∏–π –∏ —Ç.–¥.)

### 4. Levenshtein –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**levenshtein()** –≤ PHP —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å—Ç—Ä–æ–∫ (<255 —Å–∏–º–≤–æ–ª–æ–≤).

**–†–µ—à–µ–Ω–∏–µ:** –û–±—Ä–µ–∑–∞—Ç—å `core_event_en` –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤ –ø–µ—Ä–µ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º:
```php
$event1 = mb_substr($event1, 0, 200);
$event2 = mb_substr($event2, 0, 200);
```

---

## üéì –í–´–í–û–î–´

### –î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

1. ‚úÖ **–ú–æ–Ω–æ–ª–∏—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** - –Ω–µ—Ç –∏–∑–ª–∏—à–Ω–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π
2. ‚úÖ **–ü—Ä–æ—Å—Ç—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã** - Jaccard, Levenshtein, time diff
3. ‚úÖ **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ—Å—Ç—å** - –ø–æ—Ä–æ–≥–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ
4. ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - —Å–æ—Ö—Ä–∞–Ω—è–µ–º preliminary_score
5. ‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è** - 50-80% AI –≤—ã–∑–æ–≤–æ–≤
6. ‚úÖ **–ö—Ä–æ—Å—Å-—è–∑—ã–∫** - —á–µ—Ä–µ–∑ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ

### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –ø–æ–¥—Ö–æ–¥–∞

1. ‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** –ø–æ—Ä–æ–≥–∞ preliminary_similarity_threshold
2. ‚ö†Ô∏è **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –∫–∞—á–µ—Å—Ç–≤–∞** AI –ø–µ—Ä–µ–≤–æ–¥–æ–≤ entities/events
3. ‚ö†Ô∏è **–í–æ–∑–º–æ–∂–Ω—ã false negatives** –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º –ø–æ—Ä–æ–≥–µ
4. ‚ö†Ô∏è **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º–∞** - –±–æ–ª—å—à–µ –∫–æ–¥–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–∞—á–∞—Ç—å —Å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞** (60) –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å
2. **–°–æ–±–∏—Ä–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏** preliminary_score distribution
3. **–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å false negatives** –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤–µ—Å–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ** AI –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –≤ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
5. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ä–æ–≥–æ–≤ (60 vs 70 vs 80)

---

## üìÑ –§–ê–ô–õ–´ –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø/–û–ë–ù–û–í–õ–ï–ù–ò–Ø

### –°–û–ó–î–ê–¢–¨:
1. `production/sql/migration_dedup_v3.sql` - –º–∏–≥—Ä–∞—Ü–∏—è –ë–î

### –û–ë–ù–û–í–ò–¢–¨:
1. `src/Rss2Tlg/Pipeline/DeduplicationService.php` - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å (v3.0)
2. `production/configs/deduplication.json` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
3. `docs/Rss2Tlg/Pipeline_Deduplication_README.md` - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ù–ï –ò–ó–ú–ï–ù–Ø–¢–¨:
1. `src/Rss2Tlg/Pipeline/AbstractPipelineModule.php`
2. `src/Rss2Tlg/Pipeline/AIAnalysisTrait.php`
3. `production/prompts/deduplication_prompt_v2.txt` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å preliminary_score –≤ –ø—Ä–æ–º–ø—Ç)

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é `migration_dedup_v3.sql`
- [ ] –û–±–Ω–æ–≤–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã (getSummarizationData, getSimilarItems)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å calculatePreliminarySimilarity() + 6 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å analyzePreliminarySimilarity()
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å filterSuspiciousItems()
- [ ] –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å analyzeDeduplication() ‚Üí analyzeDeduplicationWithAI()
- [ ] –û–±–Ω–æ–≤–∏—Ç—å processItem() - –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –ª–æ–≥–∏–∫–∞
- [ ] –û–±–Ω–æ–≤–∏—Ç—å initializeMetrics()
- [ ] –û–±–Ω–æ–≤–∏—Ç—å saveDedupResult()
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é deduplication.json
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é Pipeline_Deduplication_README.md
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] –ö–æ–¥-—Ä–µ–≤—å—é –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] ‚è∏Ô∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–ü–û–ó–ñ–ï!)

---

**–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 2025-11-10  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** üìã PLAN READY - –ì–û–¢–û–í –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò
