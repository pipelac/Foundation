# –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞–º–∏ Telegram –±–æ—Ç–∞ (ConversationManager)

## –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–º–∏ –¥–∏–∞–ª–æ–≥–∞–º–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ Telegram –±–æ—Ç–∞. –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —à–∞–≥–∞–º–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–¥–∞–ª–µ–Ω–∏–µ–º –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

- **–ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
- **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** (id, first_name, username, last_name)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- **–¢–∞–π–º-–∞—É—Ç—ã –¥–∏–∞–ª–æ–≥–æ–≤** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö
- **–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏** –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤** –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- **–ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### –¢–∞–±–ª–∏—Ü–∞: `telegram_bot_users`

–•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞:

```sql
CREATE TABLE telegram_bot_users (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id BIGINT NOT NULL,              -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
    first_name VARCHAR(255) DEFAULT NULL, -- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    username VARCHAR(255) DEFAULT NULL,   -- Username (–±–µ–∑ @)
    last_name VARCHAR(255) DEFAULT NULL,  -- –§–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    created_at DATETIME NOT NULL,         -- –î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
    updated_at DATETIME NOT NULL,         -- –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    
    PRIMARY KEY (id),
    UNIQUE KEY idx_user_id (user_id),
    INDEX idx_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### –¢–∞–±–ª–∏—Ü–∞: `telegram_bot_conversations`

–•—Ä–∞–Ω–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤:

```sql
CREATE TABLE telegram_bot_conversations (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,
    chat_id BIGINT NOT NULL,              -- ID —á–∞—Ç–∞
    user_id BIGINT NOT NULL,              -- ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    state VARCHAR(100) NOT NULL,          -- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
    data JSON DEFAULT NULL,               -- –î–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∞ (–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ)
    message_id BIGINT UNSIGNED DEFAULT NULL, -- ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    created_at DATETIME NOT NULL,         -- –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞
    updated_at DATETIME NOT NULL,         -- –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    expires_at DATETIME NOT NULL,         -- –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
    
    PRIMARY KEY (id),
    INDEX idx_chat_user (chat_id, user_id),
    INDEX idx_expires (expires_at),
    INDEX idx_state (state)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –§–∞–π–ª: `config/telegram_bot_conversations.json`

```json
{
    "conversations": {
        "enabled": true,
        "timeout": 3600,
        "auto_create_tables": true
    }
}
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|----------|-----|----------|----------------------|
| `enabled` | bool | –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä | `false` |
| `timeout` | int | –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –¥–∏–∞–ª–æ–≥–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö | `3600` (1 —á–∞—Å) |
| `auto_create_tables` | bool | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã | `true` |

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```php
use App\Component\TelegramBot\Core\ConversationManager;

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
$db = $factory->getConnection('main');

// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
$config = ConfigLoader::load(__DIR__ . '/config/telegram_bot_conversations.json');

// –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
$conversationManager = new ConversationManager(
    $db,
    $logger,
    $config['conversations']
);
```

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```php
// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if ($update->message && $update->message->from) {
    $conversationManager->saveUser(
        $update->message->from->id,
        $update->message->from->firstName,
        $update->message->from->username,
        $update->message->from->lastName
    );
}
```

### 3. –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥

#### –®–∞–≥ 1: –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞

```php
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç /adduser
$textHandler->handleCommand($update, 'adduser', function ($message) use (
    $api,
    $conversationManager
) {
    $chatId = $message->chat->id;
    $userId = $message->from->id;
    
    // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
    $keyboard = (new InlineKeyboardBuilder())
        ->addCallbackButton('üë§ –û–±—ã—á–Ω—ã–π', 'type:user')
        ->addCallbackButton('üë®‚Äçüíº –ê–¥–º–∏–Ω', 'type:admin')
        ->build();
    
    $sentMessage = $api->sendMessage(
        $chatId,
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø:",
        ['reply_markup' => $keyboard]
    );
    
    // –ù–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–ª–æ–≥, —Å–æ—Ö—Ä–∞–Ω—è—è ID —Å–æ–æ–±—â–µ–Ω–∏—è
    $conversationManager->startConversation(
        $chatId,
        $userId,
        'awaiting_type',      // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        [],                   // –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
        $sentMessage->messageId  // ID –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
    );
});
```

#### –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É

```php
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É
$callbackHandler->handleAction($update, 'type', function ($query, $params) use (
    $api,
    $conversationManager
) {
    $chatId = $query->message->chat->id;
    $userId = $query->from->id;
    $selectedType = $params[0]; // 'user' –∏–ª–∏ 'admin'
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥
    $conversation = $conversationManager->getConversation($chatId, $userId);
    
    if (!$conversation) {
        return; // –î–∏–∞–ª–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
    }
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    if ($conversation['message_id']) {
        $api->deleteMessage($chatId, $conversation['message_id']);
    }
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
    $api->sendMessage($chatId, "–í–≤–µ–¥–∏—Ç–µ –∏–º—è:");
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
    $conversationManager->updateConversation(
        $chatId,
        $userId,
        'awaiting_name',                    // –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        ['type' => $selectedType],          // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
        null                                // –Ω–µ—Ç –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
    );
});
```

#### –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞

```php
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∏–º—è
$textHandler->handlePlainText($update, function ($message, $text) use (
    $api,
    $conversationManager
) {
    $chatId = $message->chat->id;
    $userId = $message->from->id;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ª–æ–≥
    $conversation = $conversationManager->getConversation($chatId, $userId);
    
    if (!$conversation) {
        return; // –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if ($conversation['state'] === 'awaiting_name') {
        $name = trim($text);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (empty($name)) {
            $api->sendMessage($chatId, "–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
            return;
        }
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
        $api->sendMessage($chatId, "–í–≤–µ–¥–∏—Ç–µ email:");
        
        $conversationManager->updateConversation(
            $chatId,
            $userId,
            'awaiting_email',
            ['name' => $name]  // –¥–æ–±–∞–≤–ª—è–µ–º –∏–º—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–∞–Ω–Ω—ã–º
        );
    }
    
    if ($conversation['state'] === 'awaiting_email') {
        $email = trim($text);
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è email
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $api->sendMessage($chatId, "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email!");
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
        $data = $conversation['data'];
        $keyboard = (new InlineKeyboardBuilder())
            ->addCallbackButton('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', 'confirm:yes')
            ->addCallbackButton('‚ùå –û—Ç–º–µ–Ω–∏—Ç—å', 'confirm:no')
            ->build();
        
        $sentMessage = $api->sendMessage(
            $chatId,
            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ:\n" .
            "–¢–∏–ø: {$data['type']}\n" .
            "–ò–º—è: {$data['name']}\n" .
            "Email: $email",
            ['reply_markup' => $keyboard]
        );
        
        $conversationManager->updateConversation(
            $chatId,
            $userId,
            'awaiting_confirmation',
            ['email' => $email],
            $sentMessage->messageId
        );
    }
});
```

#### –®–∞–≥ 4: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

```php
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
$callbackHandler->handleAction($update, 'confirm', function ($query, $params) use (
    $api,
    $conversationManager,
    $db
) {
    $chatId = $query->message->chat->id;
    $userId = $query->from->id;
    $action = $params[0];
    
    $conversation = $conversationManager->getConversation($chatId, $userId);
    
    if (!$conversation) {
        return;
    }
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    if ($conversation['message_id']) {
        $api->deleteMessage($chatId, $conversation['message_id']);
    }
    
    if ($action === 'yes') {
        $data = $conversation['data'];
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        $db->insert('users', [
            'type' => $data['type'],
            'name' => $data['name'],
            'email' => $data['email'],
            'created_at' => date('Y-m-d H:i:s'),
        ]);
        
        $api->sendMessage($chatId, "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
    } else {
        $api->sendMessage($chatId, "‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞");
    }
    
    // –ó–∞–≤–µ—Ä—à–∞–µ–º –¥–∏–∞–ª–æ–≥
    $conversationManager->endConversation($chatId, $userId);
});
```

### 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```php
// –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
$user = $conversationManager->getUser($userId);

if ($user) {
    echo "–ò–º—è: " . $user['first_name'] . "\n";
    echo "Username: @" . $user['username'] . "\n";
    echo "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: " . $user['created_at'] . "\n";
}
```

### 5. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤

```php
$stats = $conversationManager->getStatistics();

echo "–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤: {$stats['total']}\n";

foreach ($stats['by_state'] as $state => $count) {
    echo "$state: $count\n";
}
```

### 6. –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤

```php
// –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
$deleted = $conversationManager->cleanupExpiredConversations();
echo "–£–¥–∞–ª–µ–Ω–æ: $deleted\n";

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤ webhook –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ)
if (rand(1, 20) === 1) {  // —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 5%
    $conversationManager->cleanupExpiredConversations();
}
```

## –ü—Ä–∏–º–µ—Ä—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
1. `awaiting_type` - –æ–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. `awaiting_name` - –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
3. `awaiting_email` - –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ email
4. `awaiting_confirmation` - –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**–î–∞–Ω–Ω—ã–µ –≤ JSON:**
```json
{
    "type": "admin",
    "type_label": "üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä",
    "name": "John Doe",
    "email": "john@example.com"
}
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
1. `select_category` - –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞
2. `select_product` - –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
3. `enter_quantity` - –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
4. `enter_address` - –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
5. `confirm_order` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
1. `main_settings` - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
2. `notification_settings` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. `language_settings` - –≤—ã–±–æ—Ä —è–∑—ã–∫–∞
4. `timezone_settings` - –≤—ã–±–æ—Ä —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞

## –†–∞–±–æ—Ç–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

### –ü–∞—Ç—Ç–µ—Ä–Ω: –û–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏

```php
// –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
$sentMessage = $api->sendMessage($chatId, "–í—ã–±–µ—Ä–∏—Ç–µ:", ['reply_markup' => $keyboard]);
$conversationManager->startConversation($chatId, $userId, 'state', [], $sentMessage->messageId);

// –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
$conversation = $conversationManager->getConversation($chatId, $userId);
if ($conversation['message_id']) {
    $api->deleteMessage($chatId, $conversation['message_id']);
}
```

### –ü–∞—Ç—Ç–µ—Ä–Ω: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫

```php
// –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è
$newKeyboard = InlineKeyboardBuilder::makeSimple(['–î–∞–ª–µ–µ' => 'next']);
$api->editMessageReplyMarkup($chatId, $conversation['message_id'], $newKeyboard);
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º-–∞—É—Ç–∞–º–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏

```json
{
    "conversations": {
        "enabled": true,
        "timeout": 1800  // 30 –º–∏–Ω—É—Ç
    }
}
```

### –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

```php
// –ü—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞ —Ç–∞–π–º-–∞—É—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
$conversationManager->updateConversation($chatId, $userId, $newState, $data);
```

## –û—á–∏—Å—Ç–∫–∞ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ cron

```bash
# –ö–∞–∂–¥—ã–π —á–∞—Å
0 * * * * php /path/to/project/bin/telegram_bot_cleanup_conversations.php

# –ö–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
*/15 * * * * php /path/to/project/bin/telegram_bot_cleanup_conversations.php
```

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

```php
$deleted = $conversationManager->cleanupExpiredConversations();
```

## –û—Ç–ª–∞–¥–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```
[INFO] –ù–∞—á–∞—Ç –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥: chat_id=123, user_id=456, state=awaiting_name
[DEBUG] –î–∏–∞–ª–æ–≥ –æ–±–Ω–æ–≤–ª–µ–Ω: id=1, new_state=awaiting_email
[INFO] –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω: chat_id=123, user_id=456
[INFO] –û—á–∏—â–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∏–∞–ª–æ–≥–∏: deleted=5
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤

```php
$stats = $conversationManager->getStatistics();

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
if ($stats['total'] > 100) {
    $logger->warning('–ú–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤', ['total' => $stats['total']]);
}
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞

```php
$conversation = $conversationManager->getConversation($chatId, $userId);
if (!$conversation) {
    $api->sendMessage($chatId, "–î–∏–∞–ª–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ —Å /start");
    return;
}
```

### 2. –í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

```php
if ($conversation['state'] !== 'expected_state') {
    $logger->warning('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞');
    return;
}
```

### 3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```php
try {
    $api->deleteMessage($chatId, $messageId);
} catch (\Exception $e) {
    $logger->warning('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', [
        'message_id' => $messageId,
        'error' => $e->getMessage(),
    ]);
}
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```php
// –•–æ—Ä–æ—à–æ
'awaiting_user_email'
'confirming_order_details'
'selecting_payment_method'

// –ü–ª–æ—Ö–æ
'step1'
'state2'
'wait'
```

### 5. –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –º–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö

```php
// –•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ
$conversationManager->updateConversation($chatId, $userId, 'state', [
    'selected_id' => 123,
    'step' => 2,
]);

// –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ –±–æ–ª—å—à–∏–µ –æ–±—ä–µ–∫—Ç—ã
// ‚ùå –ü–ª–æ—Ö–æ: ['full_user_object' => $userObject]
```

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- **–û–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥** –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ
- **JSON –¥–∞–Ω–Ω—ã–µ** –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã —Ä–∞–∑–º–µ—Ä–æ–º –ø–æ–ª—è (–æ–±—ã—á–Ω–æ –¥–æ 64KB –≤ MySQL)
- **–¢–∞–π–º-–∞—É—Ç** –Ω—É–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —Ä–∞–∑—É–º–Ω–æ (–Ω–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π)
- **–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π** —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –±–æ—Ç–∞ (–Ω–µ —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤)

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –î–∏–∞–ª–æ–≥–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `enabled = true` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏

### –î–∏–∞–ª–æ–≥–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–∑–æ–≤ `endConversation()`
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `expires_at` –≤ –ë–î

### –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `message_id` —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å—Ç–∞—Ä—à–µ 48 —á–∞—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞

## –ü—Ä–∏–º–µ—Ä—ã

üìñ **–ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä:** [examples/telegram_bot_with_conversations.php](examples/telegram_bot_with_conversations.php)
üìä **–¢–µ—Å—Ç:** [tests/telegram_bot_conversation_manager_test.php](tests/telegram_bot_conversation_manager_test.php)
üîß **–£—Ç–∏–ª–∏—Ç–∞ –æ—á–∏—Å—Ç–∫–∏:** [bin/telegram_bot_cleanup_conversations.php](bin/telegram_bot_cleanup_conversations.php)

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

- PHP 8.1+
- MySQL 5.7+ / MySQL 8.0+
- InnoDB engine
- utf8mb4 –∫–æ–¥–∏—Ä–æ–≤–∫–∞
- JSON support –≤ MySQL
