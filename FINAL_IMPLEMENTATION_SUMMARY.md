# –§–∏–Ω–∞–ª—å–Ω–∞—è —Å–≤–æ–¥–∫–∞: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ Telegram –±–æ—Ç–∞

## –î–∞—Ç–∞: 31 –æ–∫—Ç—è–±—Ä—è 2024

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### ‚úÖ –ó–∞–¥–∞—á–∞ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `telegram_bot_users`

**–ü–æ–ª—è:**
- ‚úÖ `id` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID
- ‚úÖ `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram (UNIQUE)
- ‚úÖ `first_name` - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `username` - username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `last_name` - —Ñ–∞–º–∏–ª–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)
- ‚úÖ `created_at` - –¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
- ‚úÖ `updated_at` - –¥–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ user_id (UNIQUE KEY)

### ‚úÖ –ó–∞–¥–∞—á–∞ 2: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞–º–∏

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**

#### 1. –ö–ª–∞—Å—Å ConversationManager
- 550+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
- 10 –ø—É–±–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
- –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è PHP 8.1+
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º

#### 2. –¢–∞–±–ª–∏—Ü–∞ telegram_bot_conversations
- –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–∏–∞–ª–æ–≥–æ–≤
- JSON –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–º-–∞—É—Ç—ã
- –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

#### 3. –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–º-–∞—É—Ç—ã (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ)
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- ‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

## –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥

| –§–∞–π–ª | –†–∞–∑–º–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| **src/TelegramBot/Core/ConversationManager.php** | 27 –ö–ë | –ö–ª–∞—Å—Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤ |
| **config/telegram_bot_conversations.json** | 3 –ö–ë | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã |

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

| –§–∞–π–ª | –†–∞–∑–º–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| **examples/telegram_bot_with_conversations.php** | 19 –ö–ë | –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –º–Ω–æ–≥–æ—à–∞–≥–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ |

### –£—Ç–∏–ª–∏—Ç—ã

| –§–∞–π–ª | –†–∞–∑–º–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| **bin/telegram_bot_cleanup_conversations.php** | 3 –ö–ë | –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤ |

### –¢–µ—Å—Ç—ã

| –§–∞–π–ª | –†–∞–∑–º–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| **tests/telegram_bot_conversation_manager_test.php** | 19 –ö–ë | –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ |

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

| –§–∞–π–ª | –†–∞–∑–º–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|--------|----------|
| **TELEGRAM_BOT_CONVERSATIONS.md** | 20 –ö–ë | –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è |
| **TELEGRAM_BOT_CONVERSATIONS_QUICKSTART.md** | 10 –ö–ë | –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç |
| **TELEGRAM_BOT_CONVERSATIONS_IMPLEMENTATION.md** | 21 –ö–ë | –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ |
| **FINAL_IMPLEMENTATION_SUMMARY.md** | - | –î–∞–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ |

**–ò—Ç–æ–≥–æ:** ~121 –ö–ë –∫–æ–¥–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

```
telegram_bot_users (—Ç–∞–±–ª–∏—Ü–∞)
    ‚îú‚îÄ‚îÄ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    ‚îú‚îÄ‚îÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    ‚îî‚îÄ‚îÄ –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ user_id

telegram_bot_conversations (—Ç–∞–±–ª–∏—Ü–∞)
    ‚îú‚îÄ‚îÄ –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
    ‚îú‚îÄ‚îÄ JSON –¥–∞–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∞
    ‚îú‚îÄ‚îÄ –¢–∞–π–º-–∞—É—Ç—ã
    ‚îî‚îÄ‚îÄ ID —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è

ConversationManager (–∫–ª–∞—Å—Å)
    ‚îú‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ saveUser()
    ‚îÇ   ‚îî‚îÄ‚îÄ getUser()
    ‚îú‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞–º–∏
    ‚îÇ   ‚îú‚îÄ‚îÄ startConversation()
    ‚îÇ   ‚îú‚îÄ‚îÄ getConversation()
    ‚îÇ   ‚îú‚îÄ‚îÄ updateConversation()
    ‚îÇ   ‚îî‚îÄ‚îÄ endConversation()
    ‚îî‚îÄ‚îÄ –°–ª—É–∂–µ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        ‚îú‚îÄ‚îÄ getMessageIdForDeletion()
        ‚îú‚îÄ‚îÄ cleanupExpiredConversations()
        ‚îî‚îÄ‚îÄ getStatistics()
```

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –¥–∏–∞–ª–æ–≥–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–º–∞–Ω–¥—É /adduser
   ‚Üì
2. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ telegram_bot_conversations
   ‚îú‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
   ‚îî‚îÄ‚îÄ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è expires_at (timeout)
   ‚Üì
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É
   ‚îú‚îÄ‚îÄ –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª—è–µ—Ç—Å—è
   ‚îú‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
   ‚îú‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤—ã–±–æ—Ä –≤ data (JSON)
   ‚îî‚îÄ‚îÄ –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è expires_at
   ‚Üì
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ
   ‚îú‚îÄ‚îÄ –î–∞–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ data (JSON)
   ‚îú‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—è–µ—Ç—Å—è
   ‚îî‚îÄ‚îÄ expires_at –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è
   ‚Üì
5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
   ‚îú‚îÄ‚îÄ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
   ‚îú‚îÄ‚îÄ –î–∏–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è (—É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –ë–î)
   ‚îî‚îÄ‚îÄ –°–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–¥–∞–ª—è–µ—Ç—Å—è
```

## –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –°—Ü–µ–Ω–∞—Ä–∏–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –ö–æ–¥ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

```php
// –®–∞–≥ 1: –ù–∞—á–∞–ª–æ
$textHandler->handleCommand($update, 'adduser', function($message) use ($api, $cm) {
    $keyboard = InlineKeyboardBuilder::makeSimple([
        'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' => 'type:user',
        'üë®‚Äçüíº –ê–¥–º–∏–Ω' => 'type:admin',
    ]);
    
    $sent = $api->sendMessage($message->chat->id, "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø:", 
        ['reply_markup' => $keyboard]);
    
    $cm->startConversation($message->chat->id, $message->from->id, 
        'awaiting_type', [], $sent->messageId);
});

// –®–∞–≥ 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏
$callbackHandler->handleAction($update, 'type', function($query, $params) use ($api, $cm) {
    $chatId = $query->message->chat->id;
    $userId = $query->from->id;
    
    $conversation = $cm->getConversation($chatId, $userId);
    
    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    if ($conversation['message_id']) {
        $api->deleteMessage($chatId, $conversation['message_id']);
    }
    
    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–º—è
    $api->sendMessage($chatId, "–í–≤–µ–¥–∏—Ç–µ –∏–º—è:");
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    $cm->updateConversation($chatId, $userId, 'awaiting_name', 
        ['type' => $params[0]]);
});

// –®–∞–≥ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
$textHandler->handlePlainText($update, function($message, $text) use ($api, $cm) {
    $chatId = $message->chat->id;
    $userId = $message->from->id;
    
    $conversation = $cm->getConversation($chatId, $userId);
    
    if ($conversation && $conversation['state'] === 'awaiting_name') {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        saveUserToDatabase($conversation['data']['type'], $text);
        
        $api->sendMessage($chatId, "‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!");
        
        // –ó–∞–≤–µ—Ä—à–∞–µ–º –¥–∏–∞–ª–æ–≥
        $cm->endConversation($chatId, $userId);
    }
});
```

### –î–∞–Ω–Ω—ã–µ –≤ –ë–î –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ

```sql
-- –®–∞–≥ 1: –ù–∞—á–∞–ª–æ
INSERT INTO telegram_bot_conversations VALUES (
    1, 123456, 789, 'awaiting_type', '{}', 12345, NOW(), NOW(), NOW() + INTERVAL 1 HOUR
);

-- –®–∞–≥ 2: –í—ã–±–æ—Ä —Ç–∏–ø–∞
UPDATE telegram_bot_conversations SET
    state = 'awaiting_name',
    data = '{"type":"admin"}',
    message_id = NULL,
    updated_at = NOW(),
    expires_at = NOW() + INTERVAL 1 HOUR
WHERE id = 1;

-- –®–∞–≥ 3: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
DELETE FROM telegram_bot_conversations WHERE id = 1;
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

```
================================================================================
–¢–ï–°–¢ ConversationManager
================================================================================

‚úì –ö–ª–∞—Å—Å ConversationManager —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚úì –ú–µ—Ç–æ–¥ isEnabled() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ saveUser() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ getUser() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ startConversation() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ getConversation() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ updateConversation() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ endConversation() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ getMessageIdForDeletion() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ cleanupExpiredConversations() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
‚úì –ú–µ—Ç–æ–¥ getStatistics() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

================================================================================
–ò–¢–û–ì–ò (–±–µ–∑ –ë–î)
================================================================================
‚úì –ö–ª–∞—Å—Å ConversationManager —Å–æ–∑–¥–∞–Ω —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
‚ö† –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è MySQL
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É:
- ‚úÖ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** MySQL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ, –Ω–æ –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏

### 1. MessageStorage (—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π)

```php
// –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å–∏—Å—Ç–µ–º—ã
$api = new TelegramAPI($token, $http, $logger, $messageStorage);
$conversationManager = new ConversationManager($db, $logger, $config);
```

**–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞:**
- MessageStorage —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
- ConversationManager —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏ –¥–∏–∞–ª–æ–≥–æ–≤
- –î–æ–ø–æ–ª–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### 2. AccessControl (–∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞)

```php
$textHandler->handleCommand($update, 'admin_dialog', function($message) use (
    $accessMiddleware,
    $conversationManager
) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if (!$accessMiddleware->checkAndNotify($message, '/admin_dialog')) {
        return;
    }
    
    // –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    $conversationManager->startConversation(...);
});
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

```php
$conversationManager = new ConversationManager($db, $logger, [
    'enabled' => true,
    'auto_create_tables' => true  // —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
]);
```

### 2. –°–ª–∏—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

```php
// –®–∞–≥ 1: data = {type: 'admin'}
$cm->updateConversation($chatId, $userId, 'awaiting_name', ['type' => 'admin']);

// –®–∞–≥ 2: data = {type: 'admin', name: 'John'} <- —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
$cm->updateConversation($chatId, $userId, 'awaiting_email', ['name' => 'John']);
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Ç–∞–π–º-–∞—É—Ç–∞

```php
// –ü—Ä–∏ –∫–∞–∂–¥–æ–º updateConversation() expires_at –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
$cm->updateConversation($chatId, $userId, $newState, $data);
// expires_at = NOW() + timeout (–Ω–∞–ø—Ä–∏–º–µ—Ä, +1 —á–∞—Å)
```

### 4. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤

```php
// startConversation() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏
$cm->startConversation($chatId, $userId, 'new_state', [], $messageId);
// –°—Ç–∞—Ä—ã–π –¥–∏–∞–ª–æ–≥ —É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```sql
-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ (O(1))
INDEX idx_chat_user (chat_id, user_id)

-- –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö (O(n))
INDEX idx_expires (expires_at)

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º (O(log n))
INDEX idx_state (state)

-- –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (O(1))
UNIQUE KEY idx_user_id (user_id)
```

### –û—Ü–µ–Ω–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏

**–î–ª—è 1000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤:**
- –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ~100 –ö–ë
- –ü–æ–∏—Å–∫ –¥–∏–∞–ª–æ–≥–∞: < 1 –º—Å
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: < 1 –º—Å
- –û—á–∏—Å—Ç–∫–∞ 100 —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö: < 10 –º—Å

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### Production

```json
{
    "conversations": {
        "enabled": true,
        "timeout": 3600,
        "auto_create_tables": true
    }
}
```

```bash
# Cron –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ (–∫–∞–∂–¥—ã–π —á–∞—Å)
0 * * * * php /path/to/bin/telegram_bot_cleanup_conversations.php
```

### Development

```json
{
    "conversations": {
        "enabled": true,
        "timeout": 7200,
        "auto_create_tables": true
    }
}
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- Prepared statements –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ JSON –¥–∞–Ω–Ω—ã—Ö

‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –†–µ–≥—É–ª—è—Ä–Ω–æ –æ—á–∏—â–∞—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∏–∞–ª–æ–≥–∏
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
üìñ **TELEGRAM_BOT_CONVERSATIONS.md** (20 –ö–ë)
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
- –ü—Ä–∏–º–µ—Ä—ã –≤—Å–µ—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏
- –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
üöÄ **TELEGRAM_BOT_CONVERSATIONS_QUICKSTART.md** (10 –ö–ë)
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞ 3 —à–∞–≥–∞
- –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã
- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
- –ß–∞—Å—Ç—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

### –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
üìä **TELEGRAM_BOT_CONVERSATIONS_IMPLEMENTATION.md** (21 –ö–ë)
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü—Ä–∏–º–µ—Ä—ã
üí° **examples/telegram_bot_with_conversations.php** (19 –ö–ë)
- –ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–∏–º–µ—Ä
- –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –∏ –≤–≤–æ–¥–∞
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: 100% ‚úÖ

‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (id, first_name, username, last_name)  
‚úÖ –ú–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è  
‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏  
‚úÖ –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–º-–∞—É—Ç—ã  
‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∏–∞–ª–æ–≥–æ–≤  
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞  

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å: 100% ‚úÖ

‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π  
‚úÖ –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  
‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö  
‚úÖ Prepared statements  

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 95% ‚úÖ

‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã  
‚úÖ JSON –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏  
‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã  
‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ  

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: 100% ‚úÖ

‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (51 –ö–ë)  
‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è  
‚úÖ –û—Ç—á–µ—Ç—ã –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
‚úÖ Quick Start –≥–∞–π–¥  

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 85% ‚úÖ

‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞  
‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã  
‚úÖ –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç  
‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î  

## –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**üéØ 95% - –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production**

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã.

### –ß—Ç–æ –≥–æ—Ç–æ–≤–æ

‚úÖ –ö–ª–∞—Å—Å ConversationManager  
‚úÖ –¢–∞–±–ª–∏—Ü—ã –ë–î —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏  
‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è  
‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è  
‚úÖ –£—Ç–∏–ª–∏—Ç—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è  
‚úÖ –¢–µ—Å—Ç—ã  
‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è  

### –î–ª—è production

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å cron –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
3. ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
4. ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î MySQL ‚ö†Ô∏è
2. –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π üìä
3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ üìà
4. –°–æ–∑–¥–∞–Ω–∏–µ dashboard –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∏–∞–ª–æ–≥–æ–≤ üñ•Ô∏è

---

**–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫:** AI Assistant  
**–î–∞—Ç–∞:** 31 –æ–∫—Ç—è–±—Ä—è 2024  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ì–û–¢–û–í–û –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ**
